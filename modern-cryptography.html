<!doctype html>
<html>

<head>

<meta charset="UTF-8">

<link rel="stylesheet" href="/crypt/css/style.css" type="text/css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://sagecell.sagemath.org/static/embedded_sagecell.js"></script>
<script>sagecell.makeSagecell({"inputLocation": ".sage", "evalButtonText": "Run", "hide": ["permalink"]});</script>

<title>
Introduction to Cryptography — Modern Cryptography
</title>

</head>

<body>

<nav>
<header>
<h1><a href="/crypt/">Introduction to Cryptography</a></h1>
<span>
Shishir Agrawal
</span>
</header>

<div>
<h1>Contents</h1>
<ol>

<li><a href="/crypt/introduction">Introduction</a></li>

<li><a href="/crypt/classical-cryptosystems">Classical Cryptosystems</a></li>

<li><a href="/crypt/codebreaking">Codebreaking</a></li>

<li><a href="/crypt/modern-cryptography">Modern Cryptography</a></li>

</ol>
</div>

<div>
<h1>SageCells</h1>
<ul>




<li><a href="/crypt/classical-cryptosystems#sagecell-rectangular-transposition">Rectangular Transposition</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-caesar-knob">Caesar Knob</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-caesar-cipher">Caesar Cipher</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-affine-cipher">Affine Cipher</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-simple-substitution">Simple Substitution</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-hill-cipher">Hill Cipher</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-playfair-cipher">Playfair Cipher</a></li>

<li><a href="/crypt/classical-cryptosystems#sagecell-vignere-cipher">Vignère Cipher</a></li>



<li><a href="/crypt/codebreaking#sagecell-frequency-comparison">Frequency Comparison</a></li>

<li><a href="/crypt/codebreaking#sagecell-frequency-analysis">Frequency Analysis</a></li>

<li><a href="/crypt/codebreaking#sagecell-breaking-rectangular-transposition">Breaking Rectangular Transposition</a></li>

<li><a href="/crypt/codebreaking#sagecell-index-of-coincidence-comparison">Index of Coincidence Comparison</a></li>

<li><a href="/crypt/codebreaking#sagecell-breaking-vignere">Breaking Vignère</a></li>

<li><a href="/crypt/codebreaking#sagecell-known-plaintext-attack">Known Plaintext Attack</a></li>



<li><a href="/crypt/modern-cryptography#sagecell-integer-representations">Integer Representations</a></li>

<li><a href="/crypt/modern-cryptography#sagecell-rsa">RSA</a></li>

<li><a href="/crypt/modern-cryptography#sagecell-elliptic-curve-encoding">Elliptic Curve Encoding</a></li>

<li><a href="/crypt/modern-cryptography#sagecell-elliptic-curve-elgamal">Elliptic Curve Elgamal</a></li>


</ul>
</div>

<div>
Start: 2022-10-28 <br/>
Update: 2024-04-12 <br/>
<a href="https://github.com/sagrawalx/crypt">Source</a> <br/>
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
</div>

<br/><br/>
</nav>

<main>
<style>
div.element span.label::after {
    content: " 4." counter(section) "." counter(element) ". ";
}
</style>
<h1 id="modern-cryptography">4. Modern Cryptography</h1>
<ol class="section-navigation">
<li>
4.1. <a href="#primes">Interlude: Primes</a>
</li>
<li>
4.2. <a href="#euler-s-phi-function">Interlude: Euler’s Phi Function</a>
</li>
<li>
4.3. <a href="#binary-exponentiation">Interlude: Binary
Exponentiation</a>
</li>
<li>
4.4. <a href="#primality-testing">Interlude: Primality Testing</a>
</li>
<li>
4.5. <a href="#rsa">RSA</a>
</li>
<li>
4.6. <a href="#order">Interlude: Order</a>
</li>
<li>
4.7. <a href="#elgamal">Elgamal</a>
</li>
<li>
4.8. <a href="#diffie-hellman">Diffie-Hellman</a>
</li>
<li>
4.9. <a href="#elliptic-curves-over-the-reals">Interlude: Elliptic
Curves Over the Reals</a>
</li>
<li>
4.10. <a href="#elliptic-curves-mod-a-prime">Interlude: Elliptic Curves
Mod a Prime</a>
</li>
<li>
4.11. <a href="#elliptic-curve-diffie-hellman">Elliptic Curve
Diffie-Hellman</a>
</li>
<li>
4.12. <a href="#quadratic-residues">Interlude: Quadratic Residues</a>
</li>
<li>
4.13. <a href="#elliptic-curve-elgamal">Elliptic Curve Elgamal</a>
</li>
</ol>
<h2 id="primes">4.1. Interlude: Primes</h2>
<p>Here is a definition that you may have seen before:</p>
<div class="element">
<p><span class="label">Definition</span> A positive integer <span
class="math inline">\(p \geq 2\)</span> is <em>prime</em> if its only
positive divisors are 1 and itself. An integer <span
class="math inline">\(n \geq 2\)</span> that is not prime is called
<em>composite</em>.</p>
</div>
<p>For example, 5 is prime since 1 and 5 are its only divisors. 4, on
the other hand, is not prime, since 2 is a divisor of 4 (in addition to
1 and 4).</p>
<div class="element">
<p><span class="label">Exercise</span> The “twin prime conjecture” is a
famous open problem which says that there are infinitely many “twin
primes,” ie, pairs of primes that are 2 apart. For example, 3 and 5 are
twin primes, as are 5 and 7, or 11 and 13. Give five more examples of
twin primes.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> There is a version of the twin
prime conjecture which says that every even integer can be written as
the difference of consecutive primes in infinitely many ways. For
example, we have: <span class="math display">\[ 6 = 29 - 23 = 137 - 131
= 599 - 593 = \cdots \]</span> Express the integer 10 as the difference
of two consecutive primes in five different ways.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why any composite integer
<span class="math inline">\(n \geq 2\)</span> must have a prime factor
<span class="math inline">\(p\)</span> such that <span
class="math inline">\(p \leq \sqrt{n}\)</span>. Then use this fact to
determine whether or not 701 is prime.</p>
</div>
<h3 id="ubiquity-of-primes">Ubiquity of Primes</h3>
<p>There is a very important sense in which primes are “ubiquitous” —
namely, that every positive integer <span class="math inline">\(n \geq
2\)</span> can be written (uniquely!) as a product of primes. For
example, <span class="math inline">\(18 = 2 \cdot 3^2\)</span>, and both
2 and 3 are prime. An expression of an integer <span
class="math inline">\(n \geq 2\)</span> as a product of primes is called
a <em>prime factorization</em> of <span
class="math inline">\(n\)</span>.</p>
<div class="element">
<p><span class="label">Fundamental Theorem of Arithmetic</span> Any
positive integer <span class="math inline">\(n \geq 2\)</span> has a
unique prime factorization. In other words, there exists an expression
<span class="math display">\[ n = p_1^{e_1} \cdots p_r^{e_r} \]</span>
where <span class="math inline">\(p_1, \dotsc, p_r\)</span> are primes
and <span class="math inline">\(e_1, \dotsc, e_r\)</span> are positive
integers, and this expression is unique up to reordering the
indices.</p>
</div>
<p>For example, <span class="math inline">\(60 = 2^2 \cdot 3^1 \cdot
5^1\)</span> is a prime factorization of 60. It is the only one: we
could instead write <span class="math inline">\(60 = 5^1 \cdot 2^2 \cdot
3^1\)</span>, but besides this kind of reordering of the factors, there
is nothing else.</p>
<div class="element">
<p><span class="label">Exercise</span> Find the prime factorizations of
1231 and of 1232.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span></p>
<ol type="a">
<li><p>Find all prime factors of <span
class="math inline">\(50!\)</span>. (Just a list of the prime factors is
sufficient; you don’t need to find the exponents of the prime
factorization for this part.)</p></li>
<li><p>Find the prime factorization of <span
class="math inline">\(10!\)</span>.</p></li>
<li><p>Find the prime factorization of <span
class="math inline">\(11!/2^8\)</span>.</p></li>
</ol>
</div>
<p>The fundamental theorem of arithmetic is likely deeply ingrained in
your mathematical intuition, but it is in fact a “theorem” — it is
something that can and should be proved. The proof makes use of some of
the machinery we’ve already seen, so let’s prove it!</p>
<p><em>Proof of the fundamental theorem of arithmetic</em>. The
existence statement is a great example of a proof by “strong induction.”
We start by noticing that 2 is prime, so it is its own prime
factorization. Now suppose that <span class="math inline">\(n \geq
2\)</span> and that every integer <span class="math inline">\(m\)</span>
such that <span class="math inline">\(2 \leq m &lt; n\)</span> has a
prime factorization. If <span class="math inline">\(n\)</span> itself is
prime, it is again its own prime factorization and we are done. If <span
class="math inline">\(n\)</span> is composite, by definition it has a
divisor <span class="math inline">\(m\)</span> such that <span
class="math inline">\(2 \leq a &lt; n\)</span>. This means that <span
class="math inline">\(n/a = b\)</span> is an integer with <span
class="math inline">\(2 \leq b &lt; n\)</span> as well. By assumption,
both <span class="math inline">\(a\)</span> and <span
class="math inline">\(b\)</span> have prime factorizations; since <span
class="math inline">\(n = ab\)</span>, multiplying those prime
factorizations together gives us a prime factorization of <span
class="math inline">\(n\)</span>.</p>
<p>For the uniqueness statement, suppose for a contradiction that there
is an integer greater than or equal to 2 that can be written as a
product of primes in two different ways. But then there must be a
<em>smallest</em> such integer; let’s call that integer <span
class="math inline">\(n\)</span>. By assumption, we have <span
class="math inline">\(n = p_1 \cdots p_t = q_1 \cdots q_u\)</span>.
Since <span class="math inline">\(p_1\)</span> divides the left-hand
side, it must also divide the right hand side. We must have <span
class="math inline">\(\gcd(p_1, q_i) = 1\)</span> or <span
class="math inline">\(p_1\)</span>, but it cannot be equal to 1 for all
<span class="math inline">\(i\)</span> by Euclid’s lemma. Thus there
exists some <span class="math inline">\(i\)</span> such that <span
class="math inline">\(\gcd(p_1, q_i) = p_1\)</span>, which means that
<span class="math inline">\(p_1\)</span> divides <span
class="math inline">\(q_i\)</span>. Since <span
class="math inline">\(q_i\)</span> is also prime, we must have <span
class="math inline">\(p_1 = q_i\)</span>, so then we can cancel <span
class="math inline">\(p_1 = q_i\)</span> from both sides to see that
<span class="math inline">\(p_2 \cdots p_t = q_1 \cdots q_{i-1} q_{i+1}
\cdots q_u\)</span>. But now we have two distinct prime factorizations
of a number that’s strictly smaller than <span
class="math inline">\(n\)</span>, which is a contradiction! <span
style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Proof Exercise</span> Suppose <span
class="math inline">\(a\)</span> and <span
class="math inline">\(b\)</span> are positive integers. Let <span
class="math inline">\(p_1, \dotsc, p_r\)</span> be a list of distinct
primes that contains every prime factor of both <span
class="math inline">\(a\)</span> and <span
class="math inline">\(b\)</span>.</p>
<ol type="a">
<li><p>Explain why there exist non-negative integers <span
class="math inline">\(e_1, \dotsc, e_r, f_1, \dotsc, f_r\)</span> such
that <span class="math inline">\(a = p_1^{e_1} \cdots p_r^{e_r}\)</span>
and <span class="math inline">\(b = p_1^{f_1} \cdots
p_r^{f_r}\)</span>.</p></li>
<li><p>Show that <span class="math inline">\(\gcd(a, b) =
p_1^{\min\{e_1, f_1\}} \cdots p_r^{\min\{e_r, f_r\}}\)</span>.</p></li>
</ol>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span> It is a fact that there are
infinitely many prime numbers. Prove this by contradiction in two
different ways:</p>
<ol type="a">
<li><p>Suppose there are only finitely many primes <span
class="math inline">\(p_1, \dotsc, p_n\)</span>, and then consider <span
class="math inline">\(a = p_1 \cdots p_n + 1\)</span>. Find a
contradiction.</p></li>
<li><p>Suppose there are only finitely many primes and let <span
class="math inline">\(n\)</span> be an integer that’s greater than all
of them. Then consider <span class="math inline">\(a = n!+1\)</span>.
Find a contradiction.</p></li>
</ol>
</div>
<h3 id="scarcity-of-primes">Scarcity of Primes</h3>
<p>Having made the observation that primes are “ubiquitous,” we now turn
to two important senses in which primes are “scarce.” The first sense is
a literal sense: as a proportion of all integers, very few integers end
up being prime!</p>
<div class="element">
<span class="label">SageCell</span> Here is a SageCell to convince you
that primes are scarce. Hit “Run.” What you see is a plot of a function
<span class="math inline">\(f\)</span> where, for any real number <span
class="math inline">\(x \geq 2\)</span>, the corresponding <span
class="math inline">\(y\)</span>-value <span
class="math inline">\(f(x)\)</span> is the proportion of integers less
than or equal to <span class="math inline">\(x\)</span> that are prime,
for any real number <span class="math inline">\(x \geq 2\)</span>.
Notice how, in the long run, very few numbers are actually prime! Try
changing the upper endpoint 1000 and investigate how the graph changes.
<div class="sage">
<script type="text/x-sage">
plot(lambda x: prime_pi(x)/x, 2, 1000)
</script>
</div>
</div>
<p>Let me also just mention in passing that the scarcity of primes we
see in the plot above is formalized by the statement of “<a
href="https://en.wikipedia.org/wiki/Prime_number_theorem">Prime number
theorem</a>,” which is a difficult but landmark theorem in analytic
number theory.</p>
<h3 id="difficulty-of-factoring">Difficulty of Factoring</h3>
<p>The second sense in which primes are “scarce” is that prime
factorizations are extremely difficult to actually calculate, even for
moderately large numbers.</p>
<p>The naive way to find a prime factorization is to just start going
through to see what’s a factor. Let’s say, for example, that we want to
factor 75. We check first that 2 does not divide 75. We then see that 3
does divide 75, and we’re left with 25. Now 3 no longer divides 25. 4
also does not divide 25 (which we anyway knew since we already saw that
2 didn’t divide 75), but 5 does divide 25, so we divide again and we’re
left with 5. And 5 divides itself again, which leaves a 1 in the end and
we can stop. This procedure tells us that <span class="math display">\[
75 = 3^1 \cdot 5^2. \]</span> As you might imagine, this procedure gets
extremely slow as the number gets larger — or more specifically, as the
prime factors of the number get larger.</p>
<p>Computational number theorists have worked out lots of deep,
sophisticated, and clever techniques (which we do not have time to
discuss this quarter) to speed this process up, but no one has yet found
a factorization algorithm for classical computers that is
<em>substantially</em> better than the naive method we just described.
If you’ve seen some computational complexity theory, you might know what
it means to say that there is no known factorization algorithm which is
polynomial in the number of digits in the input.</p>
<div id="sagecell-hill" class="element">
<span class="label">SageCell</span> Here is a SageCell to convince you
that prime factorization is difficult. The Sage function
<code>factor</code> will factor integers. It tries to use as much
sophisticated math as possible to make this as fast as possible. It’s
certainly much faster than a human being, but it starts becoming
infeasibly slow as the size of the prime factors of the numbers grow.
Hit <code>Run</code> to see Sage factor a number with several “small”
prime factors.
<div class="sage">
<script type="text/x-sage">
factor(9845181225634534546543656534524552443341112317013333179953)
</script>
</div>
<p>Then try factoring:</p>
<pre><code>98451812256345345465436565462354534524552443341112317013333179953</code></pre>
<p>Sage will take a long time to get back to you, but it should get back
to you eventually; be patient. Then try adding or subtracting digits to
the number on your own whim to see what happens! Do you see patterns in
when Sage returns an answer quickly, or when Sage seems to struggle?</p>
</div>
<p>We’ll see below that the difficulty of factoring can be leveraged to
build modern cryptosystems that are in widespread use today.</p>
<p>Incidentally, you may have noticed two things in the discussion
above. First, we said only that no substantially better algorithm is
<em>known</em>, not that there is no such algorithm. We do not have a
proof that prime factorization cannot be done “quickly” (ie, in
polynomial time), and it is an open problem in mathematics and/or
theoretical computer science to prove this. (Or to disprove it, but
given how much time and money people have put into trying to find a
quick factorization algorithm, this seems unlikely…!)</p>
<p>The second thing you may have noticed is the phrase “classical
computers.” In fact, we do know efficient factorization algorithms for
<em>quantum</em> computers! Quantum computing hardware has not yet
caught up to our theoretical knowledge, so our modern cryptosystems are
still safe for now, but this state of affairs won’t last for much
longer. We will soon need new cryptosystems that are secure against
quantum computers.</p>
<p>The difficulty of factoring suggests that the function <span
class="math inline">\(\mu\)</span>, which takes as input two prime
numbers <span class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span> and outputs the product <span
class="math display">\[ \mu(p, q) = pq \]</span> is our first example of
a one-way function. It’s very easy to compute the product of two primes;
but, if the primes are large, it’ll be very hard to invert this function
(ie, to find the prime factors of some given number that has two large
prime factors). This is the one-way function on which RSA is based, as
we will see soon. But first, we need to develop still more theory.</p>
<h2 id="euler-s-phi-function">4.2. Interlude: Euler’s Phi Function</h2>
<p>Here’s an idea that we’ve already seen before:</p>
<div class="element">
<p><span class="label">Definition</span> For a positive integer <span
class="math inline">\(n\)</span>, let <span
class="math inline">\(\phi(n)\)</span> denote the number of integers
<span class="math inline">\(r\)</span> with <span
class="math inline">\(0 \leq r &lt; n\)</span> and <span
class="math inline">\(\gcd(n, r) = 1\)</span>. The function <span
class="math inline">\(n \mapsto \phi(n)\)</span> is called <em>Euler’s
phi function</em> (or <em>Euler’s totient function</em>).</p>
</div>
<p>For example, when we were counting that there are 312 affine
encryption functions available in English, part of the process involved
counting the number of numbers relatively prime to 26, and we found that
it was 12. We can now say this more succinctly by saying <span
class="math inline">\(\phi(26) = 12\)</span>.</p>
<div class="element">
<p><span class="label">Exercise</span> Compute <span
class="math inline">\(\phi(12), \phi(13), \phi(14)\)</span>, and <span
class="math inline">\(\phi(15)\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why, in a language that
uses an alphabet with <span class="math inline">\(n\)</span> letters,
the number of distinct affine encryption functions is <span
class="math inline">\(n\phi(n)\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Important Exercise</span> Suppose <span
class="math inline">\(p\)</span> is prime.</p>
<ol type="a">
<li>Explain why <span class="math inline">\(\phi(p) = p-1\)</span>.</li>
<li>Explain why <span class="math inline">\(\phi(p^e) = p^e - p^{e-1} =
p^{e-1}(p-1)\)</span> for any <span class="math inline">\(e \geq
1\)</span>.</li>
</ol>
</div>
<p>In fact, there is a nice formula for <span
class="math inline">\(\phi(n)\)</span> in terms of the prime
factorization of <span class="math inline">\(n\)</span>, which we now
describe. First, let us record the following property.</p>
<div class="element">
<p><span class="label">Multiplicativity of Euler’s Phi Function</span>
If <span class="math inline">\(\gcd(a, b) = 1\)</span>, then <span
class="math inline">\(\phi(ab) = \phi(a)\phi(b)\)</span>.</p>
</div>
<p><em>Proof sketch</em>. Observe that <span
class="math inline">\(\gcd(r, ab) = 1\)</span> if and only if <span
class="math inline">\(\gcd(r, a) = 1\)</span> and <span
class="math inline">\(\gcd(r, b) = 1\)</span>. Let’s arrange the numbers
0 through <span class="math inline">\(ab-1\)</span> in a grid as
follows. <span class="math display">\[ \begin{matrix} 0 &amp; 1 &amp; 2
&amp; \cdots &amp; b-1 \\
b &amp; b+1 &amp; b+2 &amp; \cdots &amp; 2b-1 \\
2b &amp; 2b+1 &amp; 2b+2 &amp; \cdots &amp; 3b-1 \\
(a-1)b &amp; (a-1)b + 1 &amp; (a-1)b + 2 &amp; \cdots &amp; ab-1
\end{matrix} \]</span> All of the numbers in a given column are
congruent mod <span class="math inline">\(b\)</span>, so if if one of
these numbers is relatively prime with <span
class="math inline">\(b\)</span>, then every number in that column must
also be relatively prime with <span class="math inline">\(b\)</span>.
Thus there are <span class="math inline">\(\phi(b)\)</span> columns that
are relatively prime with <span class="math inline">\(b\)</span>, and it
is sufficient to show that each of those columns has <span
class="math inline">\(\phi(a)\)</span> entries which are relatively
prime with <span class="math inline">\(a\)</span>.</p>
<p>The entries in the <span class="math inline">\(r\)</span>th column
are of the form <span class="math inline">\(sb + r\)</span> for <span
class="math inline">\(s\)</span> varying between 0 and <span
class="math inline">\(a-1\)</span>. Since <span
class="math inline">\(\gcd(a, b) = 1\)</span>, every congruence class
mod <span class="math inline">\(a\)</span> is represented exactly once
in each column. We know that <span
class="math inline">\(\phi(a)\)</span> of the congruence classes mod
<span class="math inline">\(a\)</span> are relatively prime to <span
class="math inline">\(a\)</span>, so we are done. <span
style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Proof Exercise</span> Fill in the details in the
above proof sketch. In particular, explain how the Affine Cipher Lemma
plays into the ideas discussed in the second paragraph of the sketch
above.</p>
</div>
<p>This brings us to the promised formula.</p>
<div class="element">
<p><span class="label">Formula for Euler’s Phi Function</span> Suppose
<span class="math inline">\(n = p_1^{e_1} \cdots p_r^{e_r}\)</span> is
the prime factorization of <span class="math inline">\(n\)</span>. Then
<span class="math display">\[ \phi(n) = p_1^{e_1-1} (p_1-1) \cdots
p_r^{e_r-1}(p_r - 1). \]</span></p>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span> Prove the formula for
Euler’s phi function using the multiplicativity property and the
calculation of <span class="math inline">\(\phi(p^e)\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Use the formula for Euler’s phi
function to calculate <span class="math inline">\(\phi(n)\)</span> for
each of the following values of <span
class="math inline">\(n\)</span>.</p>
<ol type="a">
<li><span class="math inline">\(n = 20 = 2^2 \cdot 5\)</span></li>
<li><span class="math inline">\(n = 25 = 5^2\)</span></li>
<li><span class="math inline">\(n = 30 = 2 \cdot 3 \cdot 5\)</span></li>
<li><span class="math inline">\(n = 35 = 5 \cdot 7\)</span></li>
<li><span class="math inline">\(n = 40 = 2^3 \cdot 5\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why <span
class="math inline">\(\phi(n)\)</span> is always even when <span
class="math inline">\(n \geq 3\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why we can also write
<span class="math display">\[\phi(n) = n \prod_{p \mid n} \left( 1 -
\frac{1}{p} \right). \]</span></p>
</div>
<div id="sagecell-hill" class="element">
<span class="label">SageCell</span> Sage can work with Euler’s phi
function as well. Try it!
<div class="sage">
<script type="text/x-sage">
euler_phi(75)
</script>
</div>
</div>
<p>We can now calculate Euler’s phi function, but the reason this number
is important is because of the following very important theorem.</p>
<div class="element">
<p><span class="label">Euler’s Theorem</span> Suppose <span
class="math inline">\(n\)</span> is a positive integer and <span
class="math inline">\(a\)</span> is another integer with <span
class="math inline">\(\gcd(a, n) = 1\)</span>. Then <span
class="math display">\[ a^{\phi(n)} \equiv 1 \pmod{n}. \]</span></p>
</div>
<p><em>Proof sketch</em>. Let <span class="math inline">\(r_1, \dotsc,
r_{\phi(n)}\)</span> be the integers between 0 and <span
class="math inline">\(n-1\)</span> which are relatively prime to <span
class="math inline">\(n\)</span>. Since <span
class="math inline">\(\gcd(a, n) = 1\)</span>, the integers <span
class="math inline">\(ar_1, \dotsc, ar_{\phi(n)}\)</span> represent the
same congruence classes, but maybe in a different order. Since
multiplication of integers is commutative, we have <span
class="math display">\[ r_1 \cdots r_{\phi(n)} \equiv (ar_1) \cdots
(ar_{\phi(n)}) = a^{\phi(n)} r_1 \cdots r_{\phi(n)} \pmod{n}. \]</span>
We can now multiply mod <span class="math inline">\(n\)</span> by <span
class="math inline">\(r_{\phi(n)}^{-1}\)</span>, and <span
class="math inline">\(r_{\phi(n)-1}^{-1}\)</span>, and so forth, all the
way down to <span class="math inline">\(r_1^{-1}\)</span> to conclude
that <span class="math display">\[ 1 \equiv a^{\phi(n)} \pmod{n},
\]</span> which is what we wanted to show. <span
style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Proof Exercise</span> Fill in the details in the
above proof sketch.</p>
</div>
<p>Let’s consider an example. Notice that <span class="math inline">\(20
= 2^2 \cdot 5\)</span>, so <span class="math display">\[ \phi(20) =
2^1(2-1) \cdot 5^0 (5-1) = 8. \]</span> This means that <span
class="math inline">\(a^{\phi(20)} = a^8 \equiv 1 \bmod{20}\)</span> for
any <span class="math inline">\(a\)</span> that is relatively prime to
20. For example, consider <span class="math inline">\(a = 3\)</span>. We
do in fact have <span class="math inline">\(\gcd(3, 20) = 1\)</span>,
and we can check explicitly using the Modular Arithmetic Theorem that:
<span class="math display">\[ \begin{aligned}
3^2 &amp;= 9 \\
3^4 &amp;= (3^2)^2 \equiv 9^2 = 81 \equiv 1 \pmod{20} \\
3^8 &amp;= (3^4)^2 \equiv 1^2 = 1 \pmod{20}.
\end{aligned} \]</span> We can also use this Euler’s theorem to compute
very very large powers of some number. Suppose, for example, that we
want to compute <span class="math inline">\(7^{20232023}
\bmod{20}\)</span>. Notice that <span
class="math inline">\(20232000\)</span> is divisible by 8, so we have
<span class="math display">\[ 20232023 = 20232000 + 23 \equiv 23 \equiv
7 \bmod{8}. \]</span> In other words, this means that <span
class="math inline">\(20232023 = 8q + 7\)</span> for some integer <span
class="math inline">\(q \geq 0\)</span>. We then have <span
class="math display">\[ 7^{20232023} = 7^{8q + 7} = (7^8)^q 7^7 \equiv
1^q 7^7 = 7^7 \pmod{20}. \]</span> So now we just have to compute <span
class="math inline">\(7^7 \bmod{20}\)</span>, which we can do as
follows: <span class="math display">\[ \begin{aligned}
7^2 &amp;= 49 \equiv 9 \bmod{20} \\
7^4 &amp;= (7^2)^2 \equiv 9^2 = 81 \equiv 1 \bmod{20} \\
7^7 &amp;= 7^4 \cdot 7^2 \cdot 7 \equiv 1 \cdot 9 \cdot 7 = 63 \equiv 3
\bmod{20}
\end{aligned} \]</span> We thus have <span
class="math inline">\(7^{20232023} \bmod{20} = 3\)</span>.</p>
<p>Notice that we were able to do this remainder calculation without
having to actually compute <span
class="math inline">\(7^{20232023}\)</span>. This is an important
observation, because we’ll see below that RSA will require us to do
similar remainder calculations even when the numbers are so large that
it is completely infeasible for computers to actually calculate out the
result of the exponentiation. We’ll discuss this point in more detail in
the following section.</p>
<p>Meanwhile, here are some exercises to practice with Euler’s
theorem!</p>
<div class="element">
<p><span class="label">Exercise</span> Use Euler’s theorem to show that
51 divides <span class="math inline">\(10^{32n+9} - 7\)</span> for any
integer <span class="math inline">\(n \geq 0\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Find the units digit of <span
class="math inline">\(3^{100}\)</span> using Euler’s theorem.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Fix a prime number <span
class="math inline">\(p\)</span>. There are two versions of “Fermat’s
little theorem.”</p>
<ol type="a">
<li>If <span class="math inline">\(a\)</span> is an integer that is not
divisible by <span class="math inline">\(p\)</span>, then <span
class="math inline">\(a^{p-1} \equiv 1 \pmod{p}\)</span>.</li>
<li>For any integer <span class="math inline">\(a\)</span>, we have
<span class="math inline">\(a^p \equiv a \pmod{p}\)</span>.</li>
</ol>
<p>Explain how to derive both of these statements from Euler’s theorem.
You may find it helpful to first derive statement (a), and then use that
to derive statement (b).</p>
</div>
<h2 id="binary-exponentiation">4.3. Interlude: Binary
Exponentiation</h2>
<p>With Euler’s theorem in hand, we can now compute large powers in
modular arithmetic very quickly. We saw this briefly above, but let’s
now explain the process systematically. Suppose we have a positive
integer <span class="math inline">\(n\)</span> and an integer <span
class="math inline">\(a\)</span> with <span
class="math inline">\(\gcd(a, n) = 1\)</span>, and that we want to
compute <span class="math inline">\(a^m \bmod{n}\)</span> for some large
number <span class="math inline">\(n\)</span>.</p>
<p>The first step is to calculate <span class="math inline">\(r = m
\bmod{\phi(n)}\)</span>. Indeed, if we do this, then we have <span
class="math inline">\(m = \phi(n)q + r\)</span>, so <span
class="math display">\[ a^m = a^{\phi(n)q + r} = (a^{\phi(n)})^q a^r
\equiv 1^q a^r = a^r \pmod{n} \]</span> using Euler’s Theorem (and the
Modular Arithmetic Theorem). This immediately reduces the power we have
to compute substantially.</p>
<p>We can then compute <span class="math inline">\(a^r \bmod{n}\)</span>
using a technique called “binary exponentiation.” The idea is fairly
straightforward in examples, though it can becomes hard to understand in
the abstract, so let’s start by considering an example.</p>
<p>Suppose we find that <span class="math inline">\(r = 25\)</span>. How
can we compute <span class="math inline">\(a^r \bmod{n}\)</span>? One
naive thing we could do is multiply <span
class="math inline">\(a\)</span> by itself mod <span
class="math inline">\(n\)</span> repeatedly; this would require 25
multiplications mod <span class="math inline">\(n\)</span>. Here’s
another idea. Let’s start squaring repeatedly:</p>
<ul>
<li>Find <span class="math inline">\(a^2 \bmod{n}\)</span>.</li>
<li>Find <span class="math inline">\(a^4 = (a^2)^2 \bmod{n}\)</span> by
squaring the result of the previous step.</li>
<li>Find <span class="math inline">\(a^8 = (a^4)^2 \bmod{n}\)</span> by
squaring the result of the previous step.</li>
<li>Find <span class="math inline">\(a^{16} = (a^8)^2 \bmod{n}\)</span>
by squaring the result of the previous step.</li>
</ul>
<p>If we square again, we’ll go past <span class="math inline">\(r =
25\)</span>, so we’ll stop there. We now want to figure out how to find
<span class="math inline">\(a^{25}\)</span> using the powers of <span
class="math inline">\(a\)</span> we’ve already computed. Notice that
<span class="math inline">\(25 = 16 + 8 + 1\)</span>, so <span
class="math display">\[ a^{25} = a^{16+8+1} = a^{16} a^8 a^1, \]</span>
and we already know <span class="math inline">\(a^{16}, a^8\)</span>,
and <span class="math inline">\(a\)</span> mod <span
class="math inline">\(n\)</span>, so we can compute <span
class="math inline">\(a^{25} \bmod{n}\)</span> by multiplying these
three values together mod <span class="math inline">\(n\)</span>. Notice
that this required only 6 multiplications total — much less than the 25
of the naive method!</p>
<p>Let’s see this entire process in action before describing the binary
exponentiation part in the abstract. Suppose we want to compute <span
class="math display">\[ 3^{4398391} \bmod{80}. \]</span> We first
compute <span class="math inline">\(\phi(80) = 32\)</span>, and that
<span class="math inline">\(4398391 \equiv 23 \bmod{32}\)</span>. Thus
<span class="math inline">\(3^{4398391} \equiv 3^{23} \bmod{80}\)</span>
by Euler’s Theorem. We now use binary exponentiation: <span
class="math display">\[ \begin{aligned}
3^2 &amp;= 9 \\
3^4 &amp;= (3^2)^2 = 9^2 = 81 \equiv 1 \bmod{80} \\
3^8 &amp;= (3^4)^2 \equiv 1^2 = 1 \bmod{80} \\
3^{16} &amp;= (3^8)^2 \equiv 1^2 = 1 \bmod{80} \\
3^{23} &amp;= 3^{16 + 4 + 2 + 1} = 3^{16} 3^4 3^2 3 \equiv 1 \cdot 1
\cdot 9 \cdot 3 = 27 \bmod{80}
\end{aligned} \]</span></p>
<div class="element">
<p><span class="label">Exercise</span> Compute <span
class="math inline">\(3^{293423948903859017} \bmod{50}\)</span>.</p>
</div>
<p>The “repeated squaring and then multiplying together” part of this
process is very closely related to finding binary representations of
integers. Here is the definition:</p>
<div class="element">
<p><span class="label">Definition</span> Let <span
class="math inline">\(r\)</span> be a non-negative integer. The
<em>binary representation</em> of <span class="math inline">\(r\)</span>
is a string <span class="math inline">\(b_k \cdots b_1 b_0\)</span>
where each <span class="math inline">\(b_i\)</span> is either 0 or 1,
and where <span class="math display">\[ r = b_0 + b_1 2 + b_2 2^2 +
\cdots + b_k 2^k. \]</span> The number <span
class="math inline">\(b_i\)</span> is called the <span
class="math inline">\(i\)</span>th <em>bit</em> of <span
class="math inline">\(r\)</span>. We call <span
class="math inline">\(b_0\)</span> the <em>rightmost bit</em> and <span
class="math inline">\(b_k\)</span> the <em>leftmost bit</em>.</p>
</div>
<p>For example, the binary representation of 25 is 11001 because <span
class="math display">\[ 1 + 0 \cdot 2 + 0 \cdot 2^2 + 1 \cdot 2^3 + 1
\cdot 2^4 = 1 + 8 + 16 = 25. \]</span> It is not clear at all from the
definition how to <em>find</em> this binary representation, but here is
the algorithm for doing this!</p>
<div class="element">
<p><span class="label">Algorithm for Finding Binary
Representations</span> Let <span class="math inline">\(r\)</span> be a
non-negative integer. To find the binary representation of <span
class="math inline">\(r\)</span>, divide <span
class="math inline">\(r\)</span> by 2, and then divide the quotient by
2, and then divide that quotient by 2, and so forth, until you hit a
quotient of 0. The remainders of these divisions are the binary
representation, with the last remainder corresponding to the leftmost
bit.</p>
</div>
<p>For example, suppose we want to calculate the binary representation
of 193. We divide 193 by 2, and then repeatedly divide the quotient by
2: <span class="math display">\[ \begin{aligned}
193 &amp;= 96 \cdot 2 + 1 \\
96 &amp;= 48 \cdot 2 + 0 \\
48 &amp;= 24 \cdot 2 + 0 \\
24 &amp;= 12 \cdot 2 + 0 \\
12 &amp;= 6 \cdot 2 + 0 \\
6 &amp;= 3 \cdot 2 + 0 \\
3 &amp;= 1 \cdot 2 + 1 \\
1 &amp;= 0 \cdot 2 + 1
\end{aligned} \]</span> We’ve now hit a quotient of 0, so we stop
dividing. The binary representation is the sequence of remainders we
found, with the leftmost bit being the last remainder we found and the
rightmost bit being the first remainder we found. In other words, the
binary representation of 193 is 11000001.</p>
<p>There’s a technical remark worth making here for those who are
interested in computation. The above process is an “algorithm,” but it’s
an algorithm that only human beings really have to perform…! A computer
doesn’t have to go through the above process to find the binary
representation, because a computer will already know the binary
representation of any integer: binary representations are how computers
talk about integers!</p>
<div class="element">
<p><span class="label">Exercise</span> Find binary representations of
the following integers.</p>
<ol type="a">
<li>37</li>
<li>123</li>
<li>290</li>
<li>300</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Why must the rightmost bit in the
binary representation of an even number must be 0?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> If an integer is divisible by 8,
what can you say about its binary representation?</p>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span> Prove that the output of
the above algorithm is in fact the binary representation of <span
class="math inline">\(r\)</span>.</p>
</div>
<p>We can now state the general fact about binary exponentiation we
described in the context of examples above:</p>
<div class="element">
<p><span class="label">Binary Exponentiation Lemma</span> Let <span
class="math inline">\(n\)</span> be a positive integer, and let <span
class="math inline">\(b_k \cdots b_1 b_0\)</span> be the binary
representation of a non-negative integer <span
class="math inline">\(r\)</span>. To compute <span
class="math inline">\(a^r \bmod{n}\)</span> for some integer <span
class="math inline">\(a\)</span>, first compute <span
class="math inline">\(a^{2^i} \bmod{n}\)</span> for <span
class="math inline">\(i = 0, \dotsc, k\)</span> by repeated squaring.
Then, to get <span class="math inline">\(a^r\)</span>, multiply together
all of the <span class="math inline">\(a^{2^i}\)</span> where <span
class="math inline">\(b_i = 1\)</span>. In other words, <span
class="math display">\[ a^r \equiv \prod_{b_i = 1} a^{2^i} \pmod{n}.
\]</span></p>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span> Prove the above lemma.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Show that the number of
multiplications mod <span class="math inline">\(n\)</span> that are
required to compute <span class="math inline">\(a^r \bmod{n}\)</span>
with binary exponentiation is at most <span
class="math inline">\(2\log_2(r)\)</span>.</p>
</div>
<div class="element">
<span class="label">SageCell</span> Sage performs the algorithm we’ve
described in this section when you ask it to compute remainders of high
powers. For example, the following code computes <span
class="math inline">\(3^{4398391} \bmod{80}\)</span> using this
procedure of Euler’s Theorem followed by binary exponentiation.
<div class="sage">
<script type="text/x-sage">
power_mod(3, 4398391, 80)
</script>
</div>
</div>
<div class="element">
<span class="label">SageCell</span> Sage can compute binary
representations for you as follows. Note that the output will be
prefixed with <code>0b</code> to indicate that what follows is a binary
representation.
<div class="sage">
<script type="text/x-sage">
bin(193)
</script>
</div>
</div>
<div class="element">
<p><span class="label">Exercise</span> A binary representation is also
called a base 2 representation. What is a base 3 representation, and how
do we compute it? How about base 4 representations?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Read about <a
href="https://en.wikipedia.org/wiki/Hexadecimal">hexadecimal
representations</a> of integers, and then explain what’s going on in
your own words.</p>
</div>
<h2 id="primality-testing">4.4. Interlude: Primality Testing</h2>
<p>We have one more theoretical ingredient to discuss for now: how can
we quickly figure out if a number is prime? Remember that factoring is
computationally expensive, so it’s not a good idea to try to figure out
that a number is prime by factoring it!</p>
<p>It turns out that there are a number of fast strategies for testing
primality. Here we’ll discuss one called the Miller-Rabin test. To
explain how the this test works, we need to establish some theoretical
preliminary results.</p>
<div class="element">
<p><span class="label">Lemma</span> If <span
class="math inline">\(n\)</span> is prime, the only solutions to <span
class="math inline">\(x^2 \equiv 1 \pmod{n}\)</span> are <span
class="math inline">\(x \equiv \pm 1 \pmod{n}\)</span>.</p>
</div>
<p><em>Proof</em>. Observe that <span class="math inline">\(x^2 \equiv 1
\pmod{n}\)</span> implies <span class="math display">\[0 \equiv x^2 - 1
= (x-1)(x+1) \pmod{n}, \]</span> which means that <span
class="math inline">\(n\)</span> divides <span
class="math inline">\((x-1)(x+1)\)</span>. Since <span
class="math inline">\(n\)</span> is prime, Euclid’s lemma implies that
<span class="math inline">\(n\)</span> divides either <span
class="math inline">\(x-1\)</span> or <span
class="math inline">\(x+1\)</span>, which means we have either <span
class="math inline">\(x-1 \equiv 0 \pmod{n}\)</span> or <span
class="math inline">\(x+1 \equiv 0 \pmod{n}\)</span>. In other words, we
have either <span class="math inline">\(x \equiv 1 \pmod{n}\)</span> or
<span class="math inline">\(x \equiv -1 \pmod{n}\)</span>, respectively.
<span style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Miller-Rabin Lemma</span> Suppose <span
class="math inline">\(n\)</span> is a positive odd integer and write
<span class="math inline">\(n-1 = 2^s d\)</span> for some positive
integer <span class="math inline">\(s\)</span> and an odd number <span
class="math inline">\(d\)</span>. Suppose <span
class="math inline">\(a\)</span> is an integer between 1 and <span
class="math inline">\(n-1\)</span>. If <span
class="math inline">\(n\)</span> is prime, then one of the following
congruence relations must hold true: <span class="math display">\[
\begin{aligned}
a^d &amp;\equiv 1 \pmod{n} \\
a^d &amp;\equiv -1 \pmod{n} \\
a^{2d} &amp;\equiv -1 \pmod{n} \\
a^{2^2d} &amp;\equiv -1 \pmod{n} \\
&amp;\,\vdots \\
a^{2^{s-1}d} &amp;\equiv -1 \pmod{n}
\end{aligned} \]</span></p>
</div>
<p><em>Proof</em>. Since <span class="math inline">\(1 \leq a \leq
n-1\)</span> and <span class="math inline">\(n\)</span> is prime, we
have <span class="math inline">\(\gcd(a, n) = 1\)</span>. Thus, by
Euler’s Theorem, we know that <span class="math inline">\(a^{n-1} =
a^{2^s d} \equiv 1 \pmod{n}\)</span>. This means that <span
class="math inline">\(x_1 = a^{2^{s-1}d}\)</span> is satisfies <span
class="math display">\[ x^2_1 = (a^{2^{s-1}d})^2 = a^{2^s d} \equiv 1
\pmod{n}, \]</span> so by the previous lemma, we must have either <span
class="math inline">\(x_1 \equiv -1 \pmod{n}\)</span>, in which case
we’re done, or else <span class="math inline">\(x_1 \equiv 1
\pmod{n}\)</span>. In the latter case, we can repeat the same argument
with <span class="math inline">\(x_1\)</span> replaced by <span
class="math inline">\(x_2 = a^{2^{s-2}d}\)</span>, and so on, all the
way down to <span class="math inline">\(x_s = a^d\)</span>. <span
style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<p>Let’s see what this lemma is saying in an example. Consider <span
class="math inline">\(n = 41\)</span>, which is prime. We then have
<span class="math inline">\(n-1 = 40 = 2^3 \cdot 5\)</span>. In other
words, we can take <span class="math inline">\(s = 3\)</span> and <span
class="math inline">\(d = 5\)</span> in the above lemma. Suppose we fix
some integer <span class="math inline">\(a = 17\)</span>. Since <span
class="math inline">\(s = 3\)</span>, we have 4 congruences in our list,
and one of them should then be true, so let’s check which one! We first
compute <span class="math inline">\(17^5 \equiv 27 \pmod{41}\)</span>
using binary exponentiation (as described in the previous section). This
is not <span class="math inline">\(\pm 1\)</span>, so the first two
congruence in the list fail. We then have <span class="math display">\[
17^{2 \cdot 5} = (17^5)^2 \equiv 27^2 \equiv 32 \bmod{41} \]</span> so
the third congruence also fails. But then we have <span
class="math display">\[ 17^{2^2 \cdot 5} = (17^{2 \cdot 5})^2 \equiv
32^2 \equiv 40 \equiv -1 \pmod{41} \]</span> so the last congruence is
in fact true!</p>
<div class="element">
<p><span class="label">Exercise</span></p>
<p>For each of the following integers <span
class="math inline">\(n\)</span>, find the integers <span
class="math inline">\(s\)</span> and <span
class="math inline">\(d\)</span> such that <span
class="math inline">\(n-1 = 2^s d\)</span>, where <span
class="math inline">\(d\)</span> odd.</p>
<ol type="a">
<li>43</li>
<li>49</li>
<li>65</li>
</ol>
</div>
<p>The Miller-Rabin Lemma leads us to the following definition:</p>
<div class="element">
<p><span class="label">Definition</span> Suppose <span
class="math inline">\(n\)</span> is a positive odd integer and write
<span class="math inline">\(n-1 = 2^s d\)</span> for some positive
integer <span class="math inline">\(s\)</span> and an odd number <span
class="math inline">\(d\)</span>. Suppose <span
class="math inline">\(a\)</span> is an integer between 1 and <span
class="math inline">\(n-1\)</span>. We say that <span
class="math inline">\(n\)</span> is a <em>strong probable prime to base
<span class="math inline">\(a\)</span></em> if one of the following
congruences is true: <span class="math display">\[ \begin{aligned}
a^d &amp;\equiv 1 \pmod{n} \\
a^d &amp;\equiv -1 \pmod{n} \\
a^{2d} &amp;\equiv -1 \pmod{n} \\
a^{2^2d} &amp;\equiv -1 \pmod{n} \\
&amp;\,\vdots \\
a^{2^{s-1}d} &amp;\equiv -1 \pmod{n}
\end{aligned} \]</span> If <span class="math inline">\(n\)</span> is
<em>not</em> a strong probable prime to base <span
class="math inline">\(a\)</span>, then <span
class="math inline">\(a\)</span> is called a <em>witness for the
compositness</em> of <span class="math inline">\(a\)</span>, or a
<em>Miller-Rabin witness</em> for <span
class="math inline">\(a\)</span>.</p>
</div>
<p>Using this definition, the Miller-Rabin Lemma can be restated as
saying simply that “every prime number is a strong probable prime to any
base.” This is equivalent to the contrapositive, ie, the statement that
“if <span class="math inline">\(n\)</span> is <em>not</em> a strong
probable prime to some base <span class="math inline">\(a\)</span>, then
<span class="math inline">\(n\)</span> must be composite.”</p>
<p>Consider, for example, <span class="math inline">\(n = 25\)</span>.
Of course, this number is small enough that we can see right away that
it is not actually prime! But let’s see what’s going on with this notion
of strong probable primes. Observe that <span class="math inline">\(n-1
= 24 = 2^3 \cdot 3\)</span>, so we have <span class="math inline">\(s =
3\)</span> and <span class="math inline">\(d = 3\)</span>. Suppose first
that we choose a base of <span class="math inline">\(a = 7\)</span>.
Then <span class="math display">\[ \begin{aligned}
7^3 &amp;\equiv 18 \pmod{25} \\
7^{2 \cdot 3} &amp;= (7^3)^2 \equiv 18^2 \equiv 24 \equiv -1 \pmod{25}
\end{aligned} \]</span> so this says that 25 is a strong probable prime
to base 7. If we instead choose <span class="math inline">\(a =
2\)</span>, then we have <span class="math display">\[ \begin{aligned}
2^3 &amp;= 8 \\
2^{2 \cdot 3} &amp;= (2^3)^2 = 8^2 \equiv 64 \equiv 14 \pmod{25} \\
2^{2^2 \cdot 3} &amp;= (2^{2 \cdot 3})^2 \equiv 14^2 \equiv 21 \pmod{25}
\end{aligned} \]</span> Thus <span class="math inline">\(n\)</span> is
not a strong probable prime to base 2, and 2 is a witness to the
compositeness of 25.</p>
<div class="element">
<p><span class="label">Exercise</span></p>
<ol type="a">
<li>Check that 49 is a strong probable prime to base 18. Check also that
2 is a witness to the compositeness of 49.</li>
<li>Check that <span class="math inline">\(221\)</span> is a strong
probable prime to the base 174. Check also that 2 is a witness for the
compositeness of 221.</li>
</ol>
</div>
<div class="element">
<span class="label">SageCell</span> Here is some Sage code for a
function called <code>is_strong_probable_prime</code> that checks if a
number <span class="math inline">\(n\)</span> is a strong probable prime
to some base <span class="math inline">\(a\)</span>. At the very end, we
call <code>is_strong_probable_prime(25, 7)</code> to check if 25 is a
strong probable prime to the base 7. It should return <code>True</code>.
Hit “Run” to check! Then try changing <span
class="math inline">\(n\)</span> and <span
class="math inline">\(a\)</span> and experimenting.
<div class="sage">
<script type="text/x-sage">
def is_strong_probable_prime(n, a):
    # Deal with even values of n
    if n == 2:
        return True
    elif n % 2 == 0:
        return False

    # Find s and d
    s = 0
    d = n-1
    while d % 2 == 0:
        s += 1
        d = d // 2
    
    # Compute a^d mod n
    x = power_mod(a, d, n)
    
    # If a^d \equiv 1 \pmod{n}, we are done
    if x == 1:
        return True
        
    # Otherwise, we check the -1 congruences, squaring repeatedly
    for i in range(s):
        if x == n-1:
            return True
        x = power_mod(x, 2, n)
    
    # If we've made it to the end, it means none of the congruences hold, so...
    return False
    
is_strong_probable_prime(25, 7)
</script>
</div>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why any positive odd
integer <span class="math inline">\(n\)</span> is always a strong
probable prime to base 1, and also to base <span
class="math inline">\(n-1\)</span>.</p>
</div>
<p>The idea now is as follows. If <span class="math inline">\(n\)</span>
is composite, the <em>most</em> of the possible choices of base <span
class="math inline">\(2 \leq a \leq n-2\)</span> will in fact be
witnesses for the compositeness of <span
class="math inline">\(n\)</span>. This means that, if we try several
such bases and none of them turn out to be a witness for compositness,
we can be quite sure that <span class="math inline">\(n\)</span> is in
fact prime!</p>
<div class="element">
<p><span class="label">Sage Exercise</span> Write some code that plots,
for each positive odd <em>composite</em> integer <span
class="math inline">\(n\)</span> up to 10000, the percentage of bases
<span class="math inline">\(2 \leq a \leq n-2\)</span> such that <span
class="math inline">\(n\)</span> is a strong probable prime to base
<span class="math inline">\(a\)</span>. (You should find that no more
than 25% of bases have this property.)</p>
</div>
<p>We’ve just described the Miller-Rabin primality test:</p>
<div class="element">
<p><span class="label">Miller-Rabin Primality Test</span> Suppose <span
class="math inline">\(n\)</span> is a positive integer. If <span
class="math inline">\(n\)</span> is 2, output <code>True</code>.
Otherwise, if <span class="math inline">\(n\)</span> is even, output
<code>False</code>. Otherwise, repeat the following step some fixed
pre-determined number of times:</p>
<ul>
<li>Choose a random base <span class="math inline">\(2 \leq a \leq
n-2\)</span>. If <span class="math inline">\(a\)</span> is a witness for
the compositeness of <span class="math inline">\(n\)</span>, output
<code>False</code>.</li>
</ul>
<p>If we reach the end without having output <code>False</code>, then
output <code>True</code>.</p>
</div>
<p>If we do <span class="math inline">\(k\)</span> repetitions, the
probability of a false positive is less than <span
class="math inline">\(4^{-k}\)</span>. This gets small very quickly! For
example, if we do just 10 repetitions, the probability of a false
positive is about one in a million!</p>
<div class="element">
<p><span class="label">Exercise</span> Perform the Miller-Rabin
primality test by hand for each of the following numbers:</p>
<ol type="a">
<li>13</li>
<li>15</li>
<li>9</li>
</ol>
</div>
<div class="element">
<p><span class="label">Sage Exercise</span> Write some code that
implements the Miller-Rabin primality test. It should be a function that
takes as input a positive integer <span class="math inline">\(n \geq
2\)</span> and a number of iterations <span
class="math inline">\(k\)</span>, and then perform at most <span
class="math inline">\(k\)</span> iterations as described above,
returning either <code>True</code> or <code>False</code> at the end.
Feel free to use the <code>is_strong_probable_prime</code> function
defined in the SageCell above.</p>
</div>
<p>If you don’t like the idea of a probabilistic algorithm, you may be
interested in reading about the <a
href="https://en.wikipedia.org/wiki/AKS_primality_test">AKS Primality
Test</a>, which is a fully deterministic algorithm that runs in
polynomial time (ie, polynomial in the number of digits in the input).
Note, though, that the AKS primality test often runs much slower than
the Miller-Rabin test…! If you like, you can also read about <a
href="https://en.wikipedia.org/wiki/Miller%E2%80%93Rabin_primality_test#Deterministic_variants">deterministic
variants of the Miller-Rabin test</a>.</p>
<p>The upshot is that we can quickly check if a number is prime without
having to factor it. This also gives us an algorithm for generating
large prime numbers: basically, just keep generating random numbers
until we find one that’s prime!</p>
<div class="element">
<p><span class="label">Algorithm for Generating Large Primes</span> Let
<span class="math inline">\(r\)</span> be a positive integer. To
generate an <span class="math inline">\(r\)</span>-bit prime, run the
following steps:</p>
<ul>
<li>Pick a random odd integer <span class="math inline">\(n\)</span>
between <span class="math inline">\(2^{r-1}\)</span> and <span
class="math inline">\(2^r - 1\)</span>.</li>
<li>Check if <span class="math inline">\(n\)</span> is prime.
<ul>
<li>If it is, return <span class="math inline">\(n\)</span>.</li>
<li>Otherwise, return to the first step.</li>
</ul></li>
</ul>
</div>
<div class="element">
<p><span class="label">Exercise</span> The first step of the algorithm
above requires you to pick a random <em>odd</em> integer between <span
class="math inline">\(2^{r-1}\)</span> and <span
class="math inline">\(2^r - 1\)</span>. How would you go about ensuring
that the number you pick is odd and that every odd number between <span
class="math inline">\(2^{r-1}\)</span> and <span
class="math inline">\(2^r - 1\)</span> is equally likely? <em>Hint</em>.
It might be helpful to think about binary representations.</p>
</div>
<div class="element">
<span class="label">SageCell</span> Sage has functionality to generate a
random prime using the function <code>random_prime</code>. The algorithm
it uses is very close to what’s described above, though the primality
test is not exactly the Miller-Rabin test (it instead uses the <a
href="https://en.wikipedia.org/wiki/Baillie%E2%80%93PSW_primality_test">Baillie-PSW
primality test</a>, which is a probabilistic primality test that
involves some of the same ideas). By default, it generates a random
prime between 2 and the input number:
<div class="sage">
<script type="text/x-sage">
# Generates a random "prime" between 2 and 2^100-1 
random_prime(2^100-1)
</script>
</div>
If you want to generate a random prime between something bigger than 2,
you have to tell it as follows:
<div class="sage">
<script type="text/x-sage">
# Generate a random 100-bit "prime" 
random_prime(2^100-1, lbound=2^(100-1))
</script>
</div>
Sage is using a probabilistic test, so it isn’t <em>guaranteed</em> that
the number will actually be prime: it’s just very likely to be prime! If
you want Sage to verify that the number is actually prime, you can do
that too:
<div class="sage">
<script type="text/x-sage">
# Generate a random prime between 2 and 2^100-1, and verify that it is actually prime
random_prime(2^100-1, proof=True)
</script>
</div>
</div>
<h2 id="rsa">4.5. RSA</h2>
<p>RSA is a cryptosystem named after <a
href="https://en.wikipedia.org/wiki/Ron_Rivest">Ron Rivest</a>, <a
href="https://en.wikipedia.org/wiki/Adi_Shamir">Adi Shamir</a>, and <a
href="https://en.wikipedia.org/wiki/Leonard_Adleman">Leonard
Adleman</a>, who publicly described the algorithm in 1977. The GCHQ
mathematician <a
href="https://en.wikipedia.org/wiki/Clifford_Cocks">Clifford Cocks</a>
developed an equivalent system back in 1973, but his work was not
declassified until 1997.</p>
<p>Let’s start by discussing how RSA works. We’ll then talk about why it
works, and finally about why it’s secure (or at least, probably secure
for now).</p>
<h3 id="how-to-convert-text-messages-to-numbers">How to Convert Text
Messages to Numbers</h3>
<p>We first need a preliminary discussion about how to convert text
messages into integers, since RSA only allows us to transfer integers. A
variety of methods could be employed to make this happen, but one simple
idea is for her to encode a message in the usual way (remove all
non-alphabet characters and capitalize everything), and regard the
resulting string as a number in base 26.</p>
<p>Suppose, for example, that Alice’s message is <code>HIBOB</code>.
Under the usual letter-to-number correspondence (<code>A</code> is 0,
<code>B</code> is 1, etc), these numbers correspond to the numbers 7, 8,
1, 14, 1 (in that order). We can then construct the integer <span
class="math display">\[ 1 \cdot 26^0 + 14 \cdot 26^1 + 1 \cdot 26^2 + 8
\cdot 26^3 + 7 \cdot 26^4 = 3340481. \]</span> This is an integer
representation of the message <code>HIBOB</code> in the sense that there
is a straightforward algorithm to recover the plaintext: we use the same
algorithm that we used to write a number in binary, but now we divide
repeatedly by 26 instead. <span class="math display">\[ \begin{aligned}
3340481 &amp;= 128480 \cdot 26 + 1 \\
128480 &amp;= 4941 \cdot 26 + 14 \\
4941 &amp;= 190 \cdot 26 + 1 \\
190 &amp;= 7 \cdot 26 + 8 \\
7 &amp;= 0 \cdot 26 + 7
\end{aligned} \]</span> We then look at the sequence of remainders,
starting from the bottom (ie, 7, 8, 1, 14, 1), and associate to each of
these remainders the corresponding letters to get back to the plaintext:
<code>HIBOB</code>.</p>
<div class="element">
<p><span class="label">Exercise</span></p>
<ol type="a">
<li>Find the integer representation of the text <code>GAIA</code>.</li>
<li>Find the text corresponding to the integer 245405438.</li>
</ol>
</div>
<div id="sagecell-integer-representations" class="element">
<span class="label">SageCell</span> Here is a SageCell that implements
the above described integer representations of text, and also the
reverse.
<div class="sage">
<script type="text/x-sage">
from re import sub

# Remove all non alphabetic characters and capitalize
def encode(text: str):
    stripped = sub(r"[^a-zA-Z]", "", text)
    return stripped.upper()

# Encode a string as a list of numbers 0--25
def numerify(text: str):
    return [(ord(x) - 65) for x in encode(text)]

# Turn a list of numbers 0--25 back into a string
def denumerify(nums: list):
    return "".join([chr((x % 26) + 65) for x in nums])
    
# Get integer representation
def integerify(text: str):
    n = 0
    for i, x in enumerate(reversed(numerify(text))):
        n += x * 26^i
    return n
    
# Get text from integer representation
def deintegerify(n: int):
    n = int(n)
    rems = []
    while n > 0:
        rems.append(n % 26)
        n = n // 26
    return denumerify(reversed(rems))
    
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(text=input_box(default="HIBOB", label="Input", height=2, width=70),
      actions=selector(["integerify", "deintegerify"], buttons=True, label="Action")):
    output = eval(actions)(text)
    output_div("Output", f'<textarea readonly rows="2" cols="70">{ output }</textarea>')
</script>
</div>
</div>
<div class="element">
<p><span class="label">Exercise</span> Let’s say you wanted to preserve
spaces in your message. How would you modify the above method of
associating an integer to text to make this happen?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> There’s a problem with the base
26 encoding/decoding scheme described above! Specifically, the problem
arises with words like <code>APPLE</code> or <code>AARDVARK</code>.</p>
<ol type="a">
<li>What is the problem?</li>
<li>How would you go about modifying this scheme to avoid this problem?
(There are many possible solutions, including “do nothing”…! What’s your
favorite solution, and why?)</li>
</ol>
</div>
<h3 id="how-rsa-works">How RSA Works</h3>
<p>Bob starts off by picking two distinct large primes <span
class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span>. He computes <span
class="math inline">\(n = pq\)</span> and <span
class="math inline">\(\phi(n) = (p-1)(q-1)\)</span>. He picks a random
integer <span class="math inline">\(d\)</span> between 0 and <span
class="math inline">\(\phi(n)\)</span> such that <span
class="math inline">\(\gcd(d, \phi(n)) = 1\)</span>. He then computes
<span class="math inline">\(e \equiv d^{-1} \pmod{\phi(n)}\)</span> (eg,
using the extended Euclidean algorithm). He then publishes the pair
<span class="math inline">\((n, e)\)</span> for the world to see; this
is his <em>public encryption key</em>. He keeps the remaining numbers
private.</p>
<p>Suppose Alice has a secret integer <span
class="math inline">\(m\)</span> between 0 and <span
class="math inline">\(n-1\)</span> that she wants to send to Bob. She
encrypts <span class="math inline">\(m\)</span> by computing <span
class="math inline">\(c = m^e \bmod{n}\)</span>, and this is the
ciphertext that she sends to Bob.</p>
<p>When Bob receives <span class="math inline">\(c\)</span>, he computes
<span class="math inline">\(c^d \bmod{n}\)</span>. As it turns out, this
must be <span class="math inline">\(m\)</span>, so he has received
Alice’s message!</p>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob picks the primes
<span class="math inline">\(p = 3\)</span> and <span
class="math inline">\(q = 5\)</span>. These are not even remotely large
enough primes to be secure, but it’s useful to work through small
examples to understand the generality described above. We have <span
class="math inline">\(n = pq = 15\)</span> and <span
class="math inline">\(\phi(n) = (p-1)(q-1) = 8\)</span>. Suppose Bob
further chooses <span class="math inline">\(d = 3\)</span> (which is in
fact relatively prime to 8).</p>
<ol type="a">
<li>What is Bob’s public encryption key?</li>
<li>Suppose Alice wants to send Bob the message <span
class="math inline">\(m = 7\)</span>. What is the ciphertext <span
class="math inline">\(c\)</span> that Alice sends Bob?</li>
<li>Check that, if Alice sends the ciphertext <span
class="math inline">\(c\)</span> corresponding to <span
class="math inline">\(m = 7\)</span> to Bob, that Bob actually recovers
the original plaintext.</li>
<li>Suppose Alice sends the ciphertext <span class="math inline">\(c =
2\)</span> to Bob. What is the corresponding plaintext?</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Let’s now take Eve’s perspective
to see why choosing large primes is crucial. Suppose Bob’s RSA public
key is <span class="math inline">\((35, 7)\)</span> and Alice has just
sent Bob the ciphertext <span class="math inline">\(c = 17\)</span>.
What is Bob’s decryption key? What is Alice’s plaintext message?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span></p>
<ol type="a">
<li><p>Suppose Bob’s public key has <span class="math inline">\(n =
3233\)</span>. What is the maximum integer <span
class="math inline">\(n\)</span> such that Alice can send Bob
<em>any</em> message of length <span
class="math inline">\(n\)</span>?</p></li>
<li><p>Suppose Bob wants to be able to receive <em>any</em> message with
100 characters. How big does <span class="math inline">\(n\)</span> have
to be?</p></li>
</ol>
</div>
<div id="sagecell-rsa" class="element">
<p><span class="label">SageCell</span> Here are two SageCells that
together implement RSA.</p>
The first cell generates RSA keys. You will input a number of bits; it
will then generate two primes with that many bits in their binary
representation, multiply them together to get <span
class="math inline">\(n\)</span>, and then generate <span
class="math inline">\(d\)</span> and <span
class="math inline">\(e\)</span> as described above. The larger you
choose the number of bits, the more secure the key is. Remember that
<span class="math inline">\((n, e)\)</span> is the public key, and that
<span class="math inline">\(d\)</span> must be kept secret.
<div class="sage">
<script type="text/x-sage">

# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))
    
@interact
def _(bits=input_box(default="10", label="Bits", width=62)):
    p = random_prime(2^bits-1, lbound=2^(bits-1))
    q = random_prime(2^bits-1, lbound=2^(bits-1))
    n = p*q
    phi_n = (p-1)*(q-1)
    d = randint(0, phi_n)
    while gcd(d, phi_n) != 1:
        d = randint(0, phi_n)
    e = inverse_mod(d, phi_n)
    
    output_div("n", str(n))
    output_div("e", str(e))
    output_div("d", str(d))

</script>
</div>
<p>The next cell implements the encryption and decryption. It defaults
to using a key that was generated using the above SageCell with 100-bit
primes. Encryption does not require you to enter a value for
<code>d</code>, but decryption does.</p>
<div class="sage">
<script type="text/x-sage">
from re import sub

# Remove all non alphabetic characters and capitalize
def encode(text: str):
    stripped = sub(r"[^a-zA-Z]", "", text)
    return stripped.upper()

# Encode a string as a list of numbers 0--25
def numerify(text: str):
    return [(ord(x) - 65) for x in encode(text)]

# Turn a list of numbers 0--25 back into a string
def denumerify(nums: list):
    return "".join([chr((x % 26) + 65) for x in nums])
    
# Get integer representation
def integerify(text: str):
    n = 0
    for i, x in enumerate(reversed(numerify(text))):
        n += x * 26^i
    return n
    
# Get text from integer representation
def deintegerify(n: int):
    n = int(n)
    rems = []
    while n > 0:
        rems.append(n % 26)
        n = n // 26
    return denumerify(reversed(rems))
    
# Encrypt plaintext
def encrypt(text: str, n: int, e: int):
    return power_mod(integerify(text), e, n)
    
# Decrypt ciphertext
def decrypt(c: int, n: int, d: int):
    return deintegerify(power_mod(c, d, n))
    
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(n=input_box(default="717820673049189281018479026338616874477777570300534678926289", label="n", width=62),
      e=input_box(default="214320273459987081422530851104153021999292494860068474396359", label="e", width=62),
      d=input_box(default="637365142515768052967427740225606348702321505441761588369459", label="d", width=62),
      text=input_box(default="Hi Bob!", label="Input", height=2, width=70),
      actions=selector(["encrypt", "decrypt"], buttons=True, label="Action")):
    if actions == "encrypt":
        output = encrypt(text, n, e)
    else:
        try:
            d = int(d)
            output = decrypt(int(text), n, d)
        except: 
            output = "Decryption key required for decryption!"
        output = decrypt(int(text), n, d)
    output_div("Output", f'<textarea readonly rows="2" cols="70">{ output }</textarea>')
</script>
</div>
</div>
<h3 id="why-rsa-works">Why RSA Works</h3>
<div class="element">
<p><span class="label">RSA Theorem</span> Suppose <span
class="math inline">\(p, q\)</span> are distinct primes and <span
class="math inline">\(n = pq\)</span>, that <span
class="math inline">\(d\)</span> is an integer with <span
class="math inline">\(1 \leq d \leq \phi(n)\)</span> and <span
class="math inline">\(\gcd(d, \phi(n)) = 1\)</span>, and that <span
class="math inline">\(e \equiv d^{-1} \pmod{\phi(n)}\)</span>. If <span
class="math inline">\(0 \leq m \leq n-1\)</span> and <span
class="math inline">\(c = m^e \bmod{n}\)</span>, then <span
class="math display">\[ c^d \bmod{n} = m. \]</span></p>
</div>
<p><em>Proof</em>. Observe that <span class="math inline">\(de \equiv 1
\pmod{\phi(n)}\)</span>, so there exists an integer <span
class="math inline">\(k\)</span> such that <span
class="math inline">\(de = 1 + k\phi(n)\)</span> and we have <span
class="math display">\[ c^d \equiv (m^e)^d = m^{ed} = m^{1 + k\phi(n)}
\pmod{n}. \]</span> Since <span class="math inline">\(0 \leq m &lt;
n\)</span>, it is therefore sufficient for us to show that <span
class="math inline">\(m^{1 + k\phi(n)} \equiv m \pmod{n}\)</span>.</p>
<p>There are two cases. The first case is when <span
class="math inline">\(\gcd(m, n) = 1\)</span>. Then Euler’s theorem says
that <span class="math inline">\(m^{\phi(n)} \equiv 1 \pmod{n}\)</span>,
so <span class="math display">\[ \begin{aligned}
m^{1 + k\phi(n)} = m \cdot (m^{\phi(n)})^k \equiv m \cdot 1^k = m
\pmod{n}, \end{aligned} \]</span> which is what we wanted to show.</p>
<p>The second case is when <span class="math inline">\(\gcd(m, n) \neq
1\)</span>. Since <span class="math inline">\(n = pq\)</span> and <span
class="math inline">\(0 \leq m &lt; n\)</span>, it must be that <span
class="math inline">\(\gcd(m, n) = p\)</span> or <span
class="math inline">\(\gcd(m, n) = q\)</span>. Without loss of
generality, suppose <span class="math inline">\(\gcd(m, n) = p\)</span>.
This means that <span class="math inline">\(m = xp\)</span> for some
integer <span class="math inline">\(x\)</span> and also that <span
class="math inline">\(m\)</span> is <em>not</em> divisible by <span
class="math inline">\(q\)</span>. Euler’s theorem tells us that <span
class="math inline">\(m^{q-1} \equiv 1 \pmod{q}\)</span>, so <span
class="math display">\[ m^{k\phi(n)} = m^{k(p-1)(q-1)} =
(m^{q-1})^{k(p-1)} \equiv 1^{k(p-1)} = 1 \pmod{q} \]</span> so there
exists an integer <span class="math inline">\(h\)</span> such that <span
class="math inline">\(m^{k\phi(n)} = 1 + hq\)</span>. Then <span
class="math display">\[ m^{1 + k\phi(n)} = m(1 + hq) = m + hmq = m +
hxpq = m + hxn \equiv m \pmod{n}, \]</span> which again is what we
wanted to show! <span style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Proof Exercise</span> Show that the RSA theorem
continues to hold when <span class="math inline">\(n\)</span> is a
product of arbitrarily many distinct primes (ie, not just 2 distinct
primes).</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Give an example to show that the
RSA theorem does <em>not</em> hold when <span
class="math inline">\(n\)</span> is <em>not</em> a product of two
distinct primes.</p>
<p><em>Hints</em>. In other words, you want to find an integer <span
class="math inline">\(n\)</span>, and an integer <span
class="math inline">\(d\)</span> which is relatively prime to <span
class="math inline">\(\phi(n)\)</span> with inverse <span
class="math inline">\(e\)</span>, and an integer <span
class="math inline">\(m\)</span> with <span class="math inline">\(0 \leq
m \leq n-1\)</span> such that <span class="math inline">\((m^e)^d
\not\equiv m \pmod{n}\)</span>. The RSA theorem tells us that <span
class="math inline">\(n\)</span> cannot be a product of two distinct
primes, and in fact if you did the above proof exercise, you know that
it cannot be a product of any number of distinct primes, which means the
prime factorization of <span class="math inline">\(n\)</span> must
contain at least one exponent that’s bigger than 1. Pick your favorite
such value of <span class="math inline">\(n\)</span>. Then use Euler’s
theorem to rule out many possibilities for <span
class="math inline">\(m\)</span>…</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose <span
class="math inline">\(n\)</span> is a product of two distinct primes,
that <span class="math inline">\(e\)</span> is invertible mod <span
class="math inline">\(\phi(n)\)</span>, and that <span
class="math inline">\(c\)</span> is an <span
class="math inline">\(e\)</span>th power mod <span
class="math inline">\(n\)</span>. Show that <span
class="math inline">\(c\)</span> has a <em>unique</em> <span
class="math inline">\(e\)</span>th root mod <span
class="math inline">\(n\)</span>.</p>
</div>
<h3 id="why-rsa-is-probably-secure-for-now">Why RSA is Probably Secure
(for now…)</h3>
<p>If Eve is eavesdropping on Alice and Bob’s communication, she knows
Bob’s public key <span class="math inline">\((n, e)\)</span> and she
sees Alice’s ciphertext <span class="math inline">\(c\)</span>. She
knows that <span class="math inline">\(c\)</span> is the <span
class="math inline">\(e\)</span>th power mod <span
class="math inline">\(n\)</span> of Alice’s original message <span
class="math inline">\(m\)</span>, so the security of RSA relies on the
presumed difficulty of the following problem:</p>
<div class="element">
<p><span class="label">Discrete Root Problem</span> Suppose you are
given positive integers <span class="math inline">\(n\)</span>, <span
class="math inline">\(e\)</span>, and <span
class="math inline">\(c\)</span>, and you know further that:</p>
<ul>
<li><span class="math inline">\(n\)</span> is a product of two distinct
primes (but you do not know which ones),</li>
<li><span class="math inline">\(e\)</span> is invertible mod <span
class="math inline">\(\phi(n)\)</span> (but you do not know <span
class="math inline">\(\phi(n)\)</span>), and</li>
<li><span class="math inline">\(c\)</span> is an <span
class="math inline">\(e\)</span>th power mod <span
class="math inline">\(n\)</span>.</li>
</ul>
<p>Find the unique <span class="math inline">\(e\)</span>th root of
<span class="math inline">\(c\)</span> mod <span
class="math inline">\(n\)</span>, ie, the unique integer <span
class="math inline">\(m\)</span> such that <span class="math inline">\(0
\leq m \leq n-1\)</span> such that <span class="math inline">\(m^e
\equiv c \bmod{n}\)</span>.</p>
</div>
<p>Most likely, there is no <em>fast</em> way of doing this — except for
the way that Bob uses, which requires some secret knowledge! Bob needs
to know the decryption exponent <span class="math inline">\(d\)</span>,
which is an inverse of <span class="math inline">\(e\)</span> mod <span
class="math inline">\(\phi(n)\)</span>, and knowing that would seem to
require knowing <span class="math inline">\(\phi(n)\)</span>.<a
href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a> The following lemma shows that
knowledge of <span class="math inline">\(\phi(n)\)</span> is actually
equivalent to a knowledge of a factorization of <span
class="math inline">\(n\)</span>, which is believed to be hard to find
quickly!</p>
<div class="element">
<p><span class="label">Lemma</span> Suppose <span
class="math inline">\(p, q\)</span> are distinct primes and <span
class="math inline">\(n = pq\)</span>. If Eve knows <span
class="math inline">\(n\)</span> and can quickly calculate <span
class="math inline">\(\phi(n)\)</span>, then she can also quickly find
<span class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span>.</p>
</div>
<p><em>Proof</em>. Observe that <span class="math display">\[ \phi(n) =
(p-1)(q-1) = pq - p - q + 1 = n - p - q + 1, \]</span> which means that
<span class="math display">\[ n+1-\phi(n) = p + q, \]</span> which means
that <span class="math display">\[ (x-p)(x-q) = x^2 - (p+q)x + pq = x^2
- (n+1-\phi(n))x + n. \]</span> In other words, <span
class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span> are the two roots of the quadratic
polynomial <span class="math inline">\(x^2 - (n+1-\phi(n))x +
n\)</span>, so if Eve knows how to quickly find <span
class="math inline">\(\phi(n)\)</span>, she can then just apply the
quadratic formula to this polynomial to factor <span
class="math inline">\(n\)</span> and find <span
class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span>. <span style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Exercise</span> Suppose <span
class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span> are distinct primes and <span
class="math inline">\(n = pq\)</span>. Use the quadratic formula to
write down an explicit formula for <span
class="math inline">\(p\)</span> and <span
class="math inline">\(q\)</span> in terms of <span
class="math inline">\(n\)</span> and <span
class="math inline">\(\phi(n)\)</span>.</p>
</div>
<p>In other words, the lemma tells us that, since it is believed that
there is no fast factoring algorithm for classical (ie, non-quantum)
computers, this tells us that Eve probably does not have a quick way of
finding the decryption exponent <span class="math inline">\(d\)</span>
in the same way that Bob does.</p>
<div class="element">
<p><span class="label">Exercise</span> Bob’s public key is <span
class="math inline">\((n, e)\)</span> where <span
class="math display">\[ \begin{aligned}
n &amp;= 717426848223284193177165144369883618288687316631460708260937 \\
e &amp;= 31883625115837871682689851305708348256252087949589953972423.
\end{aligned} \]</span> Unfortunately for Bob, he has chosen his public
key to be too small: this <span class="math inline">\(n\)</span> is
small enough that it can be factored by modern computers in a few
seconds! Eve has just intercepted the ciphertext <span
class="math display">\[ c =
35831783079824311094981278118129411294275821240128031455119 \]</span>
that Alice was trying to send to Bob. Find the plaintext (as text, not
just as a number).</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Do one (or more!) of the
following:</p>
<ol type="a">
<li>Play the role of Bob: Generate a RSA public key for yourself using
the <a href="#sagecell-rsa">RSA SageCells</a> and post it to our class
stream on Zulip.</li>
<li>Play the role of Alice: Watch for a classmate who has posted their
RSA public key to Zulip. Send them a secret message by encrypting it
with their public key using the <a href="#sagecell-rsa">RSA
SageCells</a>.</li>
<li>Play the role of Eve: Watch for RSA ciphertext being exchanged by
some pair of your classmates on Zulip. See if you can figure out what
the plaintext is!</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Bob chooses a large and secure
RSA key. Suppose that Alice encodes each letter in her message as an
integer 0–25 and then encrypts each of these integers individually using
Bob’s public key (instead of encoding her entire message using the
base-26 encoding scheme described above). She then sends that entire
sequence of ciphertexts over to Bob.</p>
<p>Explain why this is very insecure. In other words, suppose Eve
intercepts the sequence of ciphertexts (each corresponding to a single
letter in her message) that Alice sends to Bob. Explain how Eve will be
able to recover Alice’s message even if the modulus of Bob’s RSA public
key is too large to be factored.</p>
</div>
<h2 id="order">4.6. Interlude: Order</h2>
<p>Here is a basic definition that we will need in order to describe our
next cryptosystems.</p>
<div class="element">
<p><span class="label">Definition</span> Fix a positive integer <span
class="math inline">\(n\)</span>. If <span
class="math inline">\(a\)</span> is an integer with <span
class="math inline">\(\gcd(a, n) = 1\)</span>, the <em>order</em> of
<span class="math inline">\(a\)</span> mod <span
class="math inline">\(n\)</span>, denoted <span
class="math inline">\(\mathrm{ord}_n(a)\)</span>, is the smallest
positive integer <span class="math inline">\(k\)</span> such that <span
class="math inline">\(a^k \equiv 1 \pmod{n}\)</span>.</p>
</div>
<p>For example, suppose <span class="math inline">\(n = 7\)</span> and
<span class="math inline">\(a = 2\)</span>. We then compute: <span
class="math display">\[ \begin{aligned}
2^2 &amp;= 4 \pmod{7} \\
2^3 &amp;= 8 \equiv 1 \pmod{7}
\end{aligned} \]</span> Thus 3 is the smallest positive exponent such
that raising 2 to that power gives us something congruent to 1 mod 7,
which means that <span class="math inline">\(\mathrm{ord}_7(2) =
3\)</span>.</p>
<h3 id="order-lemmas">Order Lemmas</h3>
<p>Note that <span class="math inline">\(\phi(7) = 6\)</span>, and <span
class="math inline">\(\mathrm{ord}_7(2) = 3\)</span> happens to be a
divisor of 6. This is no coincidence!</p>
<div class="element">
<p><span class="label">First Lemma About Orders</span> Fix a positive
integer <span class="math inline">\(n\)</span> and an integer <span
class="math inline">\(a\)</span> with <span
class="math inline">\(\gcd(a, n) = 1\)</span>. If <span
class="math inline">\(m\)</span> is an integer with <span
class="math inline">\(a^m \equiv 1 \pmod{n}\)</span>, then <span
class="math inline">\(\mathrm{ord}_n(a)\)</span> divides <span
class="math inline">\(m\)</span>. In particular, <span
class="math inline">\(\mathrm{ord}_n(a)\)</span> divides <span
class="math inline">\(\phi(n)\)</span>.</p>
</div>
<p><em>Proof</em>. Let <span class="math inline">\(k =
\mathrm{ord}_n(a)\)</span>. By Euclid’s Division Lemma, we can write
<span class="math inline">\(m = kq + r\)</span> where <span
class="math inline">\(0 \leq r &lt; k\)</span>. Then <span
class="math display">\[ 1 \equiv a^m = a^{kq + r} = (a^k)^q a^r \equiv
1^q \cdot a^r = a^r \pmod{n}. \]</span> If <span
class="math inline">\(r\)</span> was nonzero, it would be a positive
exponent strictly smaller than <span class="math inline">\(k\)</span>
which gives a number congruent to 1 mod <span
class="math inline">\(n\)</span>, which contradicts the definition of
<span class="math inline">\(\mathrm{ord}(a)\)</span>. Thus it must be
that <span class="math inline">\(r = 0\)</span>, ie, that <span
class="math inline">\(k\)</span> divides <span
class="math inline">\(m\)</span>.</p>
<p>By Euler’s theorem, we know that <span
class="math inline">\(a^{\phi(n)} \equiv 1 \pmod{n}\)</span>. By what we
have just shown, we therefore know that <span
class="math inline">\(\mathrm{ord}_n(a)\)</span> divides <span
class="math inline">\(\phi(n)\)</span>. <span
style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<p>The First Order Lemma makes it a bit easier to compute the order of
an element. Suppose, for example, that we are interested in <span
class="math inline">\(n = 7\)</span> and <span class="math inline">\(a =
3\)</span>. The lemma guarantees that <span
class="math inline">\(\mathrm{ord}_7(3)\)</span> must be a divisor of
<span class="math inline">\(\phi(7) = 6\)</span>, so it can only be 1,
2, 3, or 6. We check: <span class="math display">\[ \begin{aligned}
3^1 &amp;\not\equiv 1 \pmod{7} \\
3^2 &amp;= 9 \equiv 2 \not\equiv 1 \pmod{7} \\
3^3 &amp;= 27 \equiv 6 \not\equiv 1 \pmod{7}
\end{aligned} \]</span> Thus <span
class="math inline">\(\mathrm{ord}_7(3)\)</span> cannot be 1, 2, or 3,
so we know that it must be 6.</p>
<div class="element">
<p><span class="label">Exercise</span> Calculate the following
orders.</p>
<ol type="a">
<li><span class="math inline">\(\mathrm{ord}_5(2)\)</span></li>
<li><span class="math inline">\(\mathrm{ord}_9(4)\)</span></li>
<li><span class="math inline">\(\mathrm{ord}_{10}(3)\)</span></li>
<li><span class="math inline">\(\mathrm{ord}_{11}(7)\)</span></li>
<li><span class="math inline">\(\mathrm{ord}_{13}(1)\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Second Lemma About Orders</span> Fix a positive
integer <span class="math inline">\(n\)</span> and an integer <span
class="math inline">\(a\)</span> with <span
class="math inline">\(\gcd(a, n) = 1\)</span> and let <span
class="math inline">\(k = \mathrm{ord}_n(a)\)</span>. Then <span
class="math inline">\(a^i \equiv a^j \pmod{n}\)</span> if and only if
<span class="math inline">\(i \equiv j \pmod{k}\)</span>. In particular,
the numbers <span class="math inline">\(a^0, a^1, a^2, a^3, \dotsc,
a^{k-1}\)</span> are all incongruent mod <span
class="math inline">\(n\)</span>.</p>
</div>
<p><em>Proof</em>. First suppose that <span class="math inline">\(i
\equiv j \pmod{k}\)</span>. Then there exists an integer <span
class="math inline">\(q\)</span> such that <span class="math inline">\(i
= kq + j\)</span>, so <span class="math display">\[ a^i = a^{kq + j} =
(a^k)^q a^j \equiv 1^q a^j = a^j \pmod{n} \]</span> since <span
class="math inline">\(a^k \equiv 1 \pmod{n}\)</span>. Conversely,
suppose <span class="math inline">\(a^i \equiv a^j \pmod{n}\)</span> and
assume without loss of generality that <span class="math inline">\(i
\geq j\)</span>. By multiplying both sides by <span
class="math inline">\(a^{-1}\)</span> mod <span
class="math inline">\(n\)</span> a total of <span
class="math inline">\(j\)</span> times, we find that <span
class="math inline">\(a^{i-j} \equiv 1 \pmod{n}\)</span>, so the First
Lemma About Orders tells us that <span class="math inline">\(k\)</span>
divides <span class="math inline">\(i - j\)</span>. In other words,
<span class="math inline">\(i \equiv j \pmod{k}\)</span>.</p>
<p>For the final assertion, note that <span class="math inline">\(0, 1,
2, \dotsc, k-1\)</span> are all incongruent mod <span
class="math inline">\(k\)</span>, so <span class="math inline">\(a^0,
a^1, a^2, \dotsc, a^{k-1}\)</span> must all be incongruent mod <span
class="math inline">\(n\)</span>. <span style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<span class="label">SageCell</span> Sage can find orders mod <span
class="math inline">\(n\)</span>. The following computes <span
class="math inline">\(\mathrm{ord}_5(2)\)</span>, for example.
<div class="sage">
<script type="text/x-sage">
Mod(2, 5).multiplicative_order()
</script>
</div>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span></p>
<ol type="a">
<li>If <span class="math inline">\(m\)</span> is an integer and <span
class="math inline">\(p\)</span> is an odd prime divisor of <span
class="math inline">\(m^4 + 1\)</span>, show that <span
class="math inline">\(p \equiv 1 \pmod{8}\)</span>. <em>Hint</em>. First
show carefully that <span class="math inline">\(m\)</span> has order 8
mod <span class="math inline">\(p\)</span>.</li>
<li>Show that there are infinitely many primes that are congruent to 1
mod 8. <em>Hint</em>. Suppose for a contradiction that there are only
finitely many such primes <span class="math inline">\(p_1, \dotsc,
p_r\)</span> and then apply the part (a) to the integer <span
class="math inline">\(n = (2p_1 \cdots p_r)^4 + 1\)</span>.</li>
</ol>
</div>
<h3 id="primitive-roots-and-discrete-logarithms">Primitive Roots and
Discrete Logarithms</h3>
<p>The First Lemma About Orders tells us that <span
class="math inline">\(\phi(n)\)</span> is the largest possible order mod
<span class="math inline">\(n\)</span> that any integer could have,
since the order must always be a divisor of <span
class="math inline">\(\phi(n)\)</span>. The situation when this maximum
is achived gets a special name:</p>
<div class="element">
<p><span class="label">Definition</span> Fix an integer <span
class="math inline">\(n \geq 2\)</span>. An integer <span
class="math inline">\(g\)</span> with <span
class="math inline">\(\gcd(g, n) = 1\)</span> and <span
class="math inline">\(\mathrm{ord}_n(g) = \phi(n)\)</span> is called a
<em>primitive root</em> mod <span class="math inline">\(n\)</span>.</p>
</div>
<p>For example, we saw above that <span
class="math inline">\(\mathrm{ord}_7(3) = 6 = \phi(7)\)</span>, so 3 is
a primitive root mod 7.</p>
<p>The Second Lemma About Orders tells us that <span
class="math inline">\(3^0, 3^1, 3^2, 3^3, 3^4, 3^5\)</span> are all
incongruent mod 7, but there are only 6 nonzero congruence classes mod
7, so the fact that all of the nonzero congruence classes mod 7 must be
represented among the integers <span class="math inline">\(3^0, 3^1,
3^2, 3^3, 3^4, 3^5\)</span>. Let’s check this explicitly: <span
class="math display">\[ \begin{aligned}
3^0 &amp;\equiv 1 \pmod{7} \\
3^1 &amp;\equiv 3 \pmod{7} \\
3^2 &amp;\equiv 2 \pmod{7} \\
3^3 &amp;\equiv 6 \pmod{7} \\
3^4 &amp;\equiv 4 \pmod{7} \\
3^5 &amp;\equiv 5 \pmod{7}
\end{aligned} \]</span> All of the nonzero remainders mod 7 appear in
this list. This generalizes:</p>
<div class="element">
<p><span class="label">Existence of Discrete Logarithms Lemma</span> Fix
an integer <span class="math inline">\(n \geq 2\)</span> and suppose
<span class="math inline">\(g\)</span> is a primitive root mod <span
class="math inline">\(n\)</span>. If <span class="math inline">\(\gcd(a,
n) = 1\)</span>, then there exists a unique integer <span
class="math inline">\(k\)</span> such that <span class="math inline">\(0
\leq k \leq \phi(n)\)</span> and <span class="math inline">\(g^k \equiv
a \pmod{n}\)</span>. This integer <span class="math inline">\(k\)</span>
is called the <em>discrete log base <span
class="math inline">\(g\)</span> of <span
class="math inline">\(a\)</span> mod <span
class="math inline">\(n\)</span></em> and is denoted <span
class="math inline">\(\log_g(a \bmod{n})\)</span>.</p>
</div>
<p>Our calculations above show that the discrete log base 3 of 6 mod 7
is 3, because <span class="math inline">\(3^3 \equiv 6
\pmod{7}\)</span>.</p>
<div class="element">
<p><span class="label">Exercise</span> For each of the following,
determine whether or not the proposed value of <span
class="math inline">\(g\)</span> is actually a primitive root mod <span
class="math inline">\(n\)</span>.</p>
<ol type="a">
<li><span class="math inline">\(n = 11, g = 2\)</span></li>
<li><span class="math inline">\(n = 11, g = 3\)</span></li>
<li><span class="math inline">\(n = 11, g = 4\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> For each of the following values
of <span class="math inline">\(n\)</span>, find <em>all</em> of the
primitive roots mod <span class="math inline">\(n\)</span>.</p>
<ol type="a">
<li><span class="math inline">\(n = 5\)</span></li>
<li><span class="math inline">\(n = 7\)</span></li>
<li><span class="math inline">\(n = 11\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> For each of the following, find
the discrete log base <span class="math inline">\(g\)</span> of <span
class="math inline">\(a\)</span> mod <span
class="math inline">\(n\)</span>.</p>
<ol type="a">
<li><span class="math inline">\(n = 7, g = 3, a = 5\)</span></li>
<li><span class="math inline">\(n = 5, g = 2, a = 4\)</span></li>
<li><span class="math inline">\(n = 11, g = 2, a = 3\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain in your own words why the
Second Lemma About Orders immediately implies the Existence of Discrete
Logarithms Lemma.</p>
</div>
<div class="element">
<span class="label">SageCell</span> Sage can find discrete logarithms.
It is of course much faster than trying to find discrete logarithms by
hand, but it is important to note for what’s coming next that finding
discrete logarithms seems to be an inherently hard problem: there is no
fast way of doing it, and Sage will struggle as soon as the numbers get
moderately large, just as Sage struggles with finding prime
factorizations for moderately large numbers. Here is the syntax for
finding <span class="math inline">\(\log_3(6 \bmod{7})\)</span>.
<div class="sage">
<script type="text/x-sage">
discrete_log(Mod(6,7), Mod(3,7), operation="*")
</script>
</div>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose <span
class="math inline">\(p \geq 3\)</span> is prime and <span
class="math inline">\(g\)</span> is a primitive root mod <span
class="math inline">\(p\)</span>. Explain why <span
class="math display">\[\log_g(-1 \bmod{p}) = \frac{p-1}{2}.
\]</span></p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose <span
class="math inline">\(p \geq 3\)</span> is prime and <span
class="math inline">\(g\)</span> is a primitive root mod <span
class="math inline">\(p\)</span>. Explain why <span
class="math display">\[ 1 + g + g^2 + \cdots + g^{p-1} \equiv 0
\pmod{p}. \]</span></p>
</div>
<h3 id="existence-of-primitive-roots">Existence of Primitive Roots</h3>
<p>We haven’t yet shown that primitive roots always exist, and in fact,
it is not true that primitive roots always exist. Here is the
statement:</p>
<div class="element">
<p><span class="label">Primitive Root Theorem</span> Fix an integer
<span class="math inline">\(n \geq 2\)</span>. Then there exists a
primitive root mod <span class="math inline">\(n\)</span> if and only if
<span class="math inline">\(n = 2, 4, p^k\)</span>, or <span
class="math inline">\(2p^k\)</span> for an odd prime <span
class="math inline">\(p\)</span> and a positive integer <span
class="math inline">\(k\)</span>. In particular, there always exists a
primitive root mod a prime.</p>
</div>
<p>Proving this theorem would require a somewhat lengthy tangent, so I
will omit it.</p>
<div class="element">
<p><span class="label">Exercise</span> Verify explicitly (ie, without
using the Primitive Root Theorem) that there is no primitive root mod 8.
In other words, verify that none of the integers 1, 3, 5, or 7 have
order <span class="math inline">\(\phi(8) = 4\)</span> mod 8.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Use the Primitive Root Theorem to
find the 5 smallest integers <span class="math inline">\(n \geq
2\)</span> such that there does <em>not</em> exist a primitive root mod
<span class="math inline">\(n\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span> Do one of the
following:</p>
<ol type="a">
<li>(Harder) Prove the Primitive Root Theorem yourself.</li>
<li>(Easier) Read through a proof of the Primitive Root Theorem. (For
example, see section 2.5 in Stein’s “Elementary Number Theory,” or
sections 8.2–3 in Burton’s “Elementary Number Theory,” or find another
reference you like!) Then summarize the proof strategy that you read
about in your own words.</li>
</ol>
</div>
<div class="element">
<span class="label">SageCell</span> The Sage function
<code>primitive_root</code> returns the smallest primitive root for the
input argument. For example:
<div class="sage">
<script type="text/x-sage">
primitive_root(11)
</script>
</div>
</div>
<div class="element">
<p><span class="label">Sage Exercise</span> Find the proportion of
primes <span class="math inline">\(p &lt; 1000\)</span> such that 2 is a
primitive root mod <span class="math inline">\(p\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Sage Exercise</span> Find a prime <span
class="math inline">\(p\)</span> such that the smallest primitive root
mod <span class="math inline">\(p\)</span> is <span
class="math inline">\(g = 37\)</span>.</p>
</div>
<h2 id="elgamal">4.7. Elgamal</h2>
<p>The Elgamal cryptosystem is a public-key cryptosystem like RSA, named
after the Egyptian cryptographer <a
href="https://en.wikipedia.org/wiki/Taher_Elgamal">Taher
Elgamal</a>.</p>
<h3 id="how-elgamal-works">How Elgamal Works</h3>
<p>The process begins by Bob choosing a public key. He picks a prime
number <span class="math inline">\(p\)</span> and a primitive root <span
class="math inline">\(g\)</span> of <span
class="math inline">\(p\)</span>. He chooses a random integer <span
class="math inline">\(x\)</span> with <span class="math inline">\(0 \leq
x &lt; p-1\)</span>. This is his private key. He then computes <span
class="math inline">\(h = g^x \bmod{p}\)</span> and his public key is
the triple <span class="math inline">\((p, g, h)\)</span>.</p>
<p>Suppose now that Alice wants to send Bob a message. She first encodes
her message as an integer <span class="math inline">\(m\)</span> between
0 and <span class="math inline">\(p-1\)</span>. For example, we can use
the same “base 26” strategy that we employed for RSA above. She then
chooses a random integer <span class="math inline">\(y\)</span> between
0 and <span class="math inline">\(p-1\)</span> called the “ephemeral
key.” Alice will have to choose a different ephemeral key for every
message she sends, but Bob does not have to know the value of this key
beforehand! Alice computes <span class="math inline">\(s = h^y
\bmod{p}\)</span>, <span class="math inline">\(c_1 = g^y
\bmod{p}\)</span>, and <span class="math inline">\(c_2 = ms
\pmod{p}\)</span>. Note that she can compute <span
class="math inline">\(s\)</span> and <span
class="math inline">\(c_1\)</span> quickly using binary exponentiation!
The pair <span class="math inline">\((c_1, c_2)\)</span> is the
ciphertext that she sends to Bob.</p>
<p>To decrypt the ciphertext <span class="math inline">\((c_1,
c_2)\)</span>, Bob first computes <span class="math inline">\(c_1^x
\bmod{p}\)</span>. Bob can do this quickly using binary exponentiation.
Observe that <span class="math display">\[ c_1^x \equiv (g^y)^x = g^{xy}
= (g^x)^y \equiv h^y \equiv s \bmod{p}. \]</span> In other words, Bob
has now found the same value of <span class="math inline">\(s\)</span>
that Alice had, even though he does not know the value of the ephemeral
key <span class="math inline">\(y\)</span>. He then computes an inverse
mod <span class="math inline">\(p\)</span> of <span
class="math inline">\(c_1^x\)</span> using the extended euclidean
algorithm (which is also very efficient). He then computes the product
<span class="math display">\[ c_2 (c_1^x)^{-1} \equiv c_2 s^{-1} \equiv
(ms)s^{-1} \equiv m \cdot 1 = m, \pmod{p} \]</span> and he has recovered
Alice’s message <span class="math inline">\(m\)</span>.</p>
<p>For example, suppose Bob picks the prime <span
class="math inline">\(p = 4115549\)</span>, and <span
class="math inline">\(g = 2\)</span> is his primitive root. He then
picks a random integer <span class="math inline">\(x = 2634326\)</span>.
He can then compute <span class="math inline">\(h = g^x
\bmod{p}\)</span> quickly using binary exponentiation (eg, using the
<code>power_mod</code> function in Sage); he finds <span
class="math inline">\(h = 1149114\)</span>, so the triple <span
class="math inline">\((4115549, 2, 1149114)\)</span> is his public key.
He must keep <span class="math inline">\(x = 2634326\)</span>
secret.</p>
<p>Now suppose that Alice wants to send Bob the message
<code>Hi Bob</code>. As we did earlier in the RSA section, she can
convert this to the integer <span class="math inline">\(m =
3340481\)</span>. She chooses an ephemeral key, say <span
class="math inline">\(y = 2775147\)</span>. She keeps this value of
<span class="math inline">\(y\)</span> secret. She computes <span
class="math inline">\(s = h^y \bmod{p}\)</span> using binary
exponentiation and finds <span class="math inline">\(s =
962840\)</span>. This <span class="math inline">\(s\)</span> too, she
keeps secret. She also computes <span class="math inline">\(c_1 = g^y
\bmod{p}\)</span> using binary exponentiation and finds <span
class="math inline">\(c_1 = 621674\)</span>, and finally she computes
<span class="math inline">\(c_2 = ms \bmod{p}\)</span> and finds <span
class="math inline">\(c_2 = 1911501\)</span>. The pair <span
class="math inline">\((c_1, c_2) = (621674, 1911501)\)</span> is then
the ciphertext that she sends Bob.</p>
<p>Bob receives the pair <span class="math inline">\((c_1, c_2) =
(621674, 1911501)\)</span>. He computes <span
class="math inline">\(c_1^x \bmod{p}\)</span> using binary
exponentiation and finds that it is <span
class="math inline">\(962840\)</span>, which is the same value that
Alice had found for <span class="math inline">\(s\)</span>. He computes
an inverse mod <span class="math inline">\(p\)</span> (eg, using the
Sage function <code>inverse_mod</code>) and finds <span
class="math inline">\(s^{-1} \equiv 2329074 \bmod{p = 4115549}\)</span>.
He then computes <span class="math display">\[ c_2 s^{-1} \bmod{p} =
3340481, \]</span> and he finally converts this back to the text
<code>HIBOB</code>.</p>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob picks the prime <span
class="math inline">\(p = 29\)</span> and the primitive root <span
class="math inline">\(g = 2\)</span>.</p>
<ol type="a">
<li>Suppose Bob picks <span class="math inline">\(x = 3\)</span>. What
is his public key?</li>
<li>Suppose Alice wants to send Bob the plaintext integer <span
class="math inline">\(m = 7\)</span>. What is the corresponding
ciphertext pair if the ephemeral key she chooses is <span
class="math inline">\(y = 11\)</span>?</li>
<li>Suppose Bob receives the ciphertext pair <span
class="math inline">\((3, 9)\)</span> from Alice. What is the plaintext
integer <span class="math inline">\(m\)</span>?<br />
</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> If Bob wants to be able to
receive messages with <span class="math inline">\(r = 10\)</span>
characters, how large must he choose <span
class="math inline">\(p\)</span> to be? What if <span
class="math inline">\(r = 100\)</span>? <span class="math inline">\(r =
1000\)</span>?</p>
</div>
<div class="element">
<p><span class="label">Sage Exercise</span> Write a pair of SageCells
analogous to the <a href="#sagecell-rsa">RSA SageCells</a>: one should
generate an Elgamal key, and the second should perform Elgamal
encryption and decryption.</p>
</div>
<h3 id="why-elgamal-is-probably-secure-for-now">Why Elgamal is Probably
Secure (for now…)</h3>
<p>There are at least two strategies that Eve might employ to recover
the plaintext <span class="math inline">\(m\)</span> from the ciphertext
<span class="math inline">\((c_1, c_2)\)</span>. She might try to find
Bob’s decryption key <span class="math inline">\(x\)</span> so that she
can follow Bob’s decryption strategy, but to do this, she needs to find
the discrete log base <span class="math inline">\(g\)</span> of <span
class="math inline">\(h\)</span> mod <span
class="math inline">\(p\)</span>. Alternatively, she might try to find
Alice’s ephemeral key <span class="math inline">\(y\)</span> (because
she can then compute <span class="math inline">\(h^y\)</span>, and then
<span class="math inline">\((h^y)^{-1} \equiv s^{-1} \pmod{p}\)</span>,
and then <span class="math inline">\(c_2(h^y)^{-1} \equiv (ms)s^{-1}
\equiv m \pmod{p}\)</span>), but then she needs to find the discrete log
base <span class="math inline">\(g\)</span> of <span
class="math inline">\(c_1\)</span> mod <span
class="math inline">\(p\)</span>.</p>
<p>In other words, it would seem that in either case, Eve needs to find
a discrete log base <span class="math inline">\(g\)</span> mod <span
class="math inline">\(p\)</span>. The security of the Elgamal
cryptosystem thus relies on the presumed difficulty of the following
problem:</p>
<div class="element">
<p><span class="label">Discrete Logarithm Problem</span> Suppose you are
given a prime <span class="math inline">\(p\)</span>, a primitive root
<span class="math inline">\(g\)</span> mod <span
class="math inline">\(p\)</span>, and an integer <span
class="math inline">\(a\)</span> not divisible by <span
class="math inline">\(p\)</span>. Find the discrete log base <span
class="math inline">\(g\)</span> of <span
class="math inline">\(a\)</span> mod <span
class="math inline">\(p\)</span>. In other words, find the unique
integer <span class="math inline">\(k\)</span> such that <span
class="math inline">\(0 \leq k \leq p-1\)</span> such that <span
class="math inline">\(g^k \equiv a \pmod{p}\)</span>.</p>
</div>
<p>As <span class="math inline">\(p\)</span> gets large, this problem
seems to get intractible for classical computers. The naive method to
solving this problem would be to try all the possible values of <span
class="math inline">\(k\)</span> from 1 up to <span
class="math inline">\(p-1\)</span>, but this is at least linear in <span
class="math inline">\(p\)</span>, which means it is at least exponential
in the number of digits of <span class="math inline">\(p\)</span>. There
are slightly faster algorithms than this, and these faster methods are
implemented by Sage for its discrete log functionality, but they are not
faster by much (more precisely, there is no known algorithm that
accomplishes this task that is polynomial in the number of digits of
<span class="math inline">\(p\)</span>).</p>
<div class="element">
<p><span class="label">Sage Exercise</span> Read about Shank’s Baby-Step
Giant-Step Algorithm for computing discrete logarithms. Then implement
the algorithm yourself.</p>
</div>
<div class="element">
<p><span class="label">Sage Exercise</span> Read about Pollard’s
Kangaroo Algorithm (also called “Pollard’s Lambda Algorithm”) for
computing discrete logarithms. Then implement the algorithm
yourself.</p>
</div>
<h2 id="diffie-hellman">4.8. Diffie-Hellman</h2>
<p>The Diffie-Hellman key exchange is not quite a cryptosystem for
exchanging messages; it is a protocol that allows Alice and Bob to share
a secret, but neither has full control over the content of the shared
secret. Nonetheless, the shared secret can then be used as the key for a
symmetric key cipher like a one-time pad.</p>
<p>The procedure is named after <a
href="https://en.wikipedia.org/wiki/Whitfield_Diffie">Whitfield
Diffie</a> and <a
href="https://en.wikipedia.org/wiki/Martin_Hellman">Martin Hellman</a>,
who published the protocol in 1976. The GCHQ mathematician <a
href="https://en.wikipedia.org/wiki/Malcolm_J._Williamson">Malcolm
Williamson</a> had developed the same protocol back in 1974, but his
work was only declassified in 1997.</p>
<p>The procedure is as follows. Alice and Bob publicly agree to fix a
prime <span class="math inline">\(p\)</span> and a primitive root <span
class="math inline">\(g\)</span> mod <span
class="math inline">\(p\)</span>. Alice then chooses a secret integer
<span class="math inline">\(0 \leq a &lt; p-1\)</span> and sends Bob
<span class="math inline">\(x = g^a \bmod{p}\)</span>. She can compute
this value quickly using binary exponentiation. Bob similarly chooses a
secret integer <span class="math inline">\(0 \leq b &lt; p-1\)</span>
and sends Alice <span class="math inline">\(y = g^b \bmod{p}\)</span>.
Alice computes <span class="math inline">\(s = y^a \bmod{p}\)</span>,
and Bob computes <span class="math inline">\(s = x^b \bmod{p}\)</span>.
The two values of <span class="math inline">\(s\)</span> that Alice and
Bob compute are the same, because <span class="math display">\[ y^a
\equiv (g^b)^a = g^{ab} = (g^a)^b \equiv x^b \pmod{p}. \]</span> Thus
Alice and Bob now share a secret, <span
class="math inline">\(s\)</span>. Notice that neither has full control
over the shared secret, so this cannot be regarded as Alice or Bob
sending a message to the other.</p>
<div class="element">
<p><span class="label">Exercise</span> Suppose Alice and Bob agree to
use <span class="math inline">\(p = 11\)</span> and <span
class="math inline">\(g = 2\)</span>. Alice chooses the integer <span
class="math inline">\(a = 3\)</span>. She receives the integer <span
class="math inline">\(y = 5\)</span> from Bob. What is her shared secret
<span class="math inline">\(s\)</span> with Bob?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain how the base-26
representation of Alice and Bob’s shared secret <span
class="math inline">\(s\)</span> can be used as a key for a one-time
pad.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why the presumed
difficulty finding discrete logarithms implies the security of the
Diffie-Hellman key exchange.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Do one (or both!) of the
following:</p>
<ol type="a">
<li>Play the role of Alice and Bob: Pick a friend in the class and
perform a Diffie-Hellman key exchange with them. Do your communications
in our class stream on Zulip so that everyone can see the values of
<span class="math inline">\(p, g, x, y\)</span> that you share between
the two of you, but make sure to keep <span
class="math inline">\(a\)</span> and <span
class="math inline">\(b\)</span> secret.</li>
<li>Play the role of Eve: Watch for some pair of classmates performing
Diffie-Hellman on Zulip, and then see if you can figure out their shared
secret!</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain how the Diffie-Hellman
process of producing a “shared secret” also appears as a <em>part</em>
of the Elgamal cryptosystem.</p>
</div>
<p>There are many other cryptographic protocols besides the
Diffie-Hellman key exchange which involve the presumed difficulty of the
discrete log problem and which are not strictly about exchanging
messages. Here are some examples:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Schnorr_signature">Schnorr
signature algorithm</a></li>
<li><a
href="https://en.wikipedia.org/wiki/ElGamal_signature_scheme">Elgamal
signature scheme</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Digital_Signature_Algorithm">DSA</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Zero-knowledge_proof#Discrete_log_of_a_given_value">Zero-knowledge
proofs of discrete logarithms</a></li>
</ul>
<div class="element">
<p><span class="label">Sage Exercise</span> Read about one of the
protocols listed above, and then implement it!</p>
</div>
<h2 id="elliptic-curves-over-the-reals">4.9. Interlude: Elliptic Curves
Over the Reals</h2>
<p>We’ll start with a discussion of elliptic curves over the real
numbers in order to develop some geometric intuition about elliptic
curves.</p>
<div class="element">
<p><span class="label">Definition</span> A <em>Weierstrass equation</em>
over the real numbers is an equation in <span
class="math inline">\(x\)</span> and <span
class="math inline">\(y\)</span> of the form <span
class="math display">\[ y^2 = x^3 + ax + b \]</span> where <span
class="math inline">\(a, b\)</span> are fixed real numbers. The
<em>discriminant</em> of the equation is <span class="math display">\[
\Delta = -16(4a^3 + 27b^2) \]</span> and the equation is
<em>singular</em> when <span class="math inline">\(\Delta = 0\)</span>.
Otherwise, the equation is said to be <em>nonsingular</em>.</p>
</div>
<p>Here is a theorem that is useful to keep in mind, but we omit a proof
because it will not be important for us in cryptography:</p>
<div class="element">
<p><span class="label">Theorem</span> The Weierstrass equation <span
class="math inline">\(y^2 = x^3 + ax + b\)</span> is nonsingular if and
only if the cubic equation <span class="math inline">\(x^3 + ax + b =
0\)</span> has no repeated roots in the complex numbers.</p>
</div>
<p>Given a Weierstrass equation, we can make a plot of the points <span
class="math inline">\((x, y)\)</span> in the plane that satisfy that
equation. Here is a SageCell that makes these plots for you; make sure
to play with it before moving forward!</p>
<div id="sagecell-elliptic-plotter" class="element">
<p><span class="label">SageCell / Exercise</span> This SageCell makes
plots of curves defined by Weierstrass equations. It defaults to <span
class="math inline">\(y^2 = x^3 - 1\)</span>. The view box defaults to
the range <span class="math inline">\(-3 \leq x, y \leq 3\)</span>, but
you can change the 3 using the ``View’’ input box. The cell tells you
whether the curve is singular or not, and then makes plots. Use the
SageCell to look at plots of the following curves:</p>
<ol type="a">
<li><span class="math inline">\(y^2 = x^3 + b\)</span> for <span
class="math inline">\(b = 0, -1, -2, -3, \dotsc, -6\)</span></li>
<li><span class="math inline">\(y^2 = x^3 + ax\)</span> for <span
class="math inline">\(a = -6, -5, \dotsc, 0, 1, \dotsc, 6\)</span></li>
<li><span class="math inline">\(y^2 = x^3 + ax + \sqrt{4/27}\)</span>
for <span class="math inline">\(a = -0.5, -0.8, -0.9, -0.99, -1, -1.01,
-1.1, -1.2, -1.5\)</span></li>
</ol>
<p>Note that you can enter expressions like <code>sqrt(4/27)</code> in
the input box for <code>b</code>.</p>
<div class="sage">
<script type="text/x-sage">
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(a=input_box(default="-1", label="a", width=62), 
      b=input_box(default="0", label="b", width=62),
      r=input_box(default="3", label="View", width=62),
      ):
    
    var("x y")
    delta = 4*a^3 + 27*b^2
    output_div("Δ", f"{float(delta):.2f}")
    output_div("Sing?", float(delta) == 0)
    p = implicit_plot(y^2 - x^3 - a*x - b, (x,-r,r), (y,-r,r))
    p.show(axes=True, frame=False)
</script>
</div>
</div>
<p>What you should have found by playing with the above SageCell is that
the set of points satisfying a <em>nonsingular</em> Weierstrass equation
always roughly has one of the following shapes:</p>
<div style="text-align: center; margin: auto;">
<p><img style="width: 40%; display: inline-block;" src="/crypt/img/elliptic1.png"/>
<img style="width: 40%; display: inline-block;" src="/crypt/img/elliptic2.png"/></p>
</div>
<p>These curves have a lot of important geometry. To get started,
observe that they are symmetric about the <span
class="math inline">\(x\)</span>-axis, ie, they have vertical symmetry.
Stated formally, if <span class="math inline">\((x, y)\)</span> is a
point satisfying <span class="math inline">\(y^2 = x^3 + ax +
b\)</span>, then its reflection <span class="math inline">\((x,
-y)\)</span> across the <span class="math inline">\(x\)</span>-axis is
also a point satisfying the same equation! If <span
class="math inline">\(P = (x, y)\)</span> is a point on a curve defined
by a Weierstrass equation, we define <span
class="math inline">\(-P\)</span> to be this reflection <span
class="math inline">\((x, -y)\)</span>. (Careful: we only invert the
<span class="math inline">\(y\)</span>-coordinate of <span
class="math inline">\(P\)</span> to get <span
class="math inline">\(-P\)</span>, not both coordinates!)</p>
<p>Here is the second property: if I pick any two points on the curve,
the unique line that passes through those two points will have a unique
“other” point of intersection with the curve. Well, <em>almost</em>…!
But we will get to this <em>almost</em> soon. First, here is an
example:</p>
<p>Consider the Weierstrass equation <span class="math display">\[ y^2 =
x^3 + 17. \]</span> It is nonsingular because <span
class="math display">\[ \Delta = -16(4 \cdot 0^3 + 27 \cdot 17^2) = -16
\cdot 27 \cdot 17^2 \neq 0. \]</span> Consider the points <span
class="math inline">\(P = (-2, 3)\)</span> and <span
class="math inline">\(Q = (-1, 4)\)</span>. Both of these lie on the
curve, as you should verify:</p>
<div class="element">
<p><span class="label">Exercise</span> Check that <span
class="math inline">\(P = (-2, 3)\)</span> and <span
class="math inline">\(Q = (-1, 4)\)</span> are both on the curve defined
by <span class="math inline">\(y^2 = x^3 + 17\)</span>.</p>
</div>
<p>There is a unique “secant” line that passes through these two points.
We can calculate its slope using the usual rise-over-run formula as
<span class="math display">\[ m = \frac{4 - 3}{-1 - (-2)} = \frac{1}{1}
= 1 \]</span> and then we can find the equation of the secant line
itself using point-slope form: <span class="math display">\[
\begin{aligned}
y - 4 &amp;= 1 \cdot (x - (-1)) \\
y &amp;= x + 5
\end{aligned} \]</span> Let’s now think about intersecting this secant
line with the curve. This will consist of all <span
class="math inline">\((x, y)\)</span> which satisfy both <span
class="math inline">\(y = x + 5\)</span> and also <span
class="math inline">\(y^2 = x^3 + 17\)</span>, so if we substitute the
first equation in the second, we see that we must have <span
class="math display">\[ \begin{aligned}
(x+5)^2 &amp;= x^3 + 17 \\
x^2 + 10x + 25 &amp;= x^3 + 17 \\
x^3 - x^2 - 10x - 8 &amp;= 0
\end{aligned} \]</span> We now have to solve a cubic equation, which
isn’t easy in general, but here’s the trick: we already know that <span
class="math inline">\(x = -2\)</span> and <span class="math inline">\(x
= -1\)</span> must be solutions to this equation! After all, we know
that <span class="math inline">\(P = (-2, 3)\)</span> and <span
class="math inline">\(Q = (-1, 4)\)</span> are on the curve and on the
line, and the <span class="math inline">\(x\)</span>-coodinates of these
points are precisely <span class="math inline">\(-2\)</span> and <span
class="math inline">\(-1\)</span>. This means that <span
class="math inline">\((x+2)(x+1) = x^2 + 3x + 2\)</span> must divide
<span class="math inline">\(x^3 - x^2 - 10x - 8\)</span>, and we can use
polynomial long division to find the quotient.</p>
<div class="element">
<p><span class="label">Exercise</span> Use polynomial long division to
divide <span class="math inline">\(x^3 - x^2 - 10x - 8\)</span> by <span
class="math inline">\(x^2 + 3x + 2\)</span> and check that the quotient
is <span class="math inline">\(x-4\)</span> and the remainder is 0.</p>
</div>
<p>The upshot is that <span class="math inline">\(x^3 - x^2 - 10x - 8 =
(x+2)(x+1)(x-4)\)</span>, so the third solution to the cubic equation
<span class="math inline">\(x^3 - x^2 - 10x - 8 = 0\)</span> is <span
class="math inline">\(x = 4\)</span>. If we plug <span
class="math inline">\(x = 4\)</span> into the equation of the line, we
find the point <span class="math inline">\(R = (4, 9)\)</span>. We
already know by construction that this point <span
class="math inline">\(R\)</span> must satisfy the Weierstrass equation
too, but you should check this:</p>
<div class="element">
<p><span class="label">Exercise</span> Check that <span
class="math inline">\(R = (4, 9)\)</span> is on the curve defined <span
class="math inline">\(y^2 = x^3 + 17\)</span>.</p>
</div>
<p>Here is the picture of what we’ve just done:</p>
<div style="text-align: center; margin: auto;">
<p><img style="width: 80%; display: inline-block;" src="/crypt/img/elliptic3.png"/></p>
</div>
<p>As indicated in the picture, we will define <span
class="math inline">\(P+Q\)</span> to be the negative of this third
point of intersection. Be careful: this process is much more complicated
than simply adding the <span class="math inline">\(x\)</span> and <span
class="math inline">\(y\)</span> coordinates of the two points! You
should do the following exercise before proceeding:</p>
<div class="element">
<p><span class="label">Exercise</span></p>
<ol type="a">
<li>Let <span class="math inline">\(S = (2, 5)\)</span>. Check that
<span class="math inline">\(S\)</span> is on the same curve <span
class="math inline">\(y^2 = x^3 + 17\)</span>.</li>
<li>What is the third point of the intersection on between the curve
<span class="math inline">\(y^2 = x^3 + 17\)</span> and the secand line
connecting <span class="math inline">\(Q = (-1, 4)\)</span> and <span
class="math inline">\(S\)</span>?</li>
<li>What is <span class="math inline">\(Q + S\)</span>?</li>
<li>With <span class="math inline">\(P = (-2, 3)\)</span> and <span
class="math inline">\(R = (4, 9)\)</span> on <span
class="math inline">\(y^2 = x^3 + 17\)</span> as above, what is <span
class="math inline">\(P + R\)</span>?</li>
</ol>
</div>
<p>Let’s now return to the “almost” we mentioned above. In fact, this
“almost” actually encompassed two caveats that we need to discuss.</p>
<p>The first caveat has to do with the case when the two points we start
with are the same point. Consider again the situation <span
class="math inline">\(P = (-2, 3)\)</span>. How can we make sense of
<span class="math inline">\(P + P\)</span>, or <span
class="math inline">\(2P\)</span>? The very first step involves finding
the equation of the secant line that passes through <span
class="math inline">\(P\)</span> and <span
class="math inline">\(P\)</span>, but there isn’t a unique such
line…!</p>
<p>But, if you think back to your calculus classes, you might remember
that: if you think about the secant lines through two points on a curve,
and take the limit as one of the two points approaches the other, what
you wind up with is the tangent line! So we’ll use this. In other words,
to define <span class="math inline">\(P + P\)</span>, we’ll go through
the same process that we did above, but we’ll use the tangent line of
the curve at <span class="math inline">\(P\)</span>.</p>
<p>Let’s work this out. To find the slope of the tangent line, we use
implicit differentiation on the equation <span class="math inline">\(y^2
= x^3 + 17\)</span>. We get <span class="math display">\[ 2y
\frac{dy}{dx} = 3x^2 \]</span> and then we plug in <span
class="math inline">\(P = (x, y) = (-2, 3)\)</span> to get <span
class="math display">\[ \begin{aligned}
2 \cdot 3 \cdot \left.\frac{dy}{dx}\right|_P &amp;= 3(-2)^2 \\
\left.\frac{dy}{dx}\right|_P &amp;= 2
\end{aligned} \]</span> We then find the equation of the tangent line
again using point-slope form like we did above: <span
class="math display">\[ \begin{aligned}
y - 3 &amp;= 2(x - (-2)) \\
y &amp;= 2x + 7
\end{aligned} \]</span> We now want to intersect this point with the
curve, so we again substitute <span class="math inline">\(y =
2x+7\)</span> into <span class="math inline">\(y^2 = x^3 + 17\)</span>
like we did above: <span class="math display">\[ \begin{aligned}
(2x+7)^2 &amp;= x^3 + 17 \\
4x^2 + 28x + 49 &amp;= x^3 + 17 \\
x^3 - 4x^2 - 28x - 32 &amp;= 0
\end{aligned} \]</span> We again have a cubic equation to factor. Last
time, we knew two factors of the cubic because we knew two points on the
intersection. This time, we only know one point of the intersection, but
we know that the line is tangent to the curve at <span
class="math inline">\(P\)</span>, so the <span
class="math inline">\(x\)</span>-coordinate of <span
class="math inline">\(P\)</span>, ie <span class="math inline">\(x =
-2\)</span>, must be a double root of this cubic! This means that the
cubic must be divisible by <span class="math inline">\((x-(-2))^2 = x^2
+ 4x + 4\)</span>, and we can again use polynomial long division to find
the “third” point of intersection.</p>
<div class="element">
<p><span class="label">Exercise</span> Use polynomial long division to
divide <span class="math inline">\(x^3 - 4x^2 - 28x - 32\)</span> by
<span class="math inline">\(x^2 + 4x + 4\)</span> and check that the
quotient is <span class="math inline">\(x-8\)</span> and the remainder
is 0.</p>
</div>
<p>This means that the third point of intersection has <span
class="math inline">\(x\)</span>-coordinate 8, so its <span
class="math inline">\(y\)</span>-coordinate is <span
class="math inline">\(2 \cdot 8 + 7 = 23\)</span>. We then reflect this
point across the <span class="math inline">\(x\)</span>-axis and find
that <span class="math inline">\(2P = (8, -23)\)</span>. Here is a
picture of what we have just done:</p>
<div style="text-align: center; margin: auto;">
<p><img style="width: 80%; display: inline-block;" src="/crypt/img/elliptic4.png"/></p>
</div>
<p>Note that the curve looks different from the previous picture only
because of the scale on the axes; it is the same curve.</p>
<div class="element">
<p><span class="label">Exercise</span> On the same curve <span
class="math inline">\(y^2 = x^3 + 17\)</span>, calculate the
following.</p>
<ol type="a">
<li><span class="math inline">\(2Q\)</span>, where <span
class="math inline">\(Q = (-1, 4)\)</span>.</li>
<li><span class="math inline">\(2S\)</span>, where <span
class="math inline">\(S = (2, 5)\)</span>.</li>
</ol>
</div>
<p>This brings us to the second caveat that was encompassed by our
“almost.” There is one situation when the line passing through two
points (either the secant line through two distinct points or the
tangent line at a single point) does not have a third point of
intersection with the curve. This will happen precisely when the line
ends up being vertical! This should be clear from the geometry, but you
should verify it algebraically:</p>
<div class="element">
<p><span class="label">Exercise</span> Verify algebraically that the
secant line passing through <span class="math inline">\((-2, 3)\)</span>
and <span class="math inline">\((-2, -3)\)</span> is vertical, and that
this line has no other point of intersection with the curve <span
class="math inline">\(y^2 = x^3 + 17\)</span>.</p>
</div>
<p>We deal with this <em>by fiat</em>. We declare that there is a point,
denoted <span class="math inline">\(O\)</span> and called <em>the point
at infinity</em>, which is a point on the curve defined by <span
class="math inline">\(y^2 = x^3 + 17\)</span> and is also a point on
every vertical line in the plane. It is its own negative. Thus, if we’re
trying to “add” two points and encounter the situation where a secant or
tangent line is vertical, we declare the sum to be <span
class="math inline">\(O\)</span>.</p>
<div class="element">
<p><span class="label">Exercise</span> Based on our definition of <span
class="math inline">\(O\)</span> as being “point on the curve defined by
<span class="math inline">\(y^2 = x^3 + 17\)</span> and also a point on
every vertical line in the plane,” explain why it makes sense to assert
that <span class="math inline">\(P + O = P\)</span> for <span
class="math inline">\(P = (-2, 3)\)</span> – or, in fact, for any point
<span class="math inline">\(P\)</span> on the curve.</p>
</div>
<p>Having worked through this extended example, we can now make some
formal statements.</p>
<div class="element">
<p><span class="label">Definition-Theorem</span> Fix a nonsingular
Weiertrass equation <span class="math inline">\(y^2 = x^3 + ax +
b\)</span>. The <em>elliptic curve</em> <span
class="math inline">\(E\)</span> defined by this equation is the set of
points <span class="math inline">\((x, y)\)</span> satisfying this
equation, together with a <em>point at infinity</em> denoted <span
class="math inline">\(O\)</span> and assumed by fiat to:</p>
<ul>
<li>lie on the curve;</li>
<li>lie on every vertical line in the plane; and</li>
<li>be its own reflection across the <span
class="math inline">\(x\)</span>-axis.</li>
</ul>
<p>Given any <span class="math inline">\(P \in E\)</span>, we define
<span class="math inline">\(-P\)</span> to be the reflection of <span
class="math inline">\(P\)</span> across the <span
class="math inline">\(x\)</span>-axis. Given any two points <span
class="math inline">\(P, Q \in E\)</span>, there is a unique secant or
tangent line passing through <span class="math inline">\(P\)</span> and
<span class="math inline">\(Q\)</span>, and this line has a unique third
point of intersection with the curve; we define <span
class="math inline">\(P+Q\)</span> to be the negative of this third
point of intersection. Then:</p>
<ul>
<li>(Associativity) <span class="math inline">\((P + Q) + R = P + (Q +
R)\)</span> for any <span class="math inline">\(P, Q, R \in
E\)</span>.</li>
<li>(Commutativity) <span class="math inline">\(P + Q = Q + P\)</span>
for any <span class="math inline">\(P, Q \in E\)</span>.</li>
<li>(Identity) <span class="math inline">\(P + O = P\)</span> for any
<span class="math inline">\(P \in E\)</span>.</li>
<li>(Inverses) <span class="math inline">\(P + (-P) = O\)</span> for any
<span class="math inline">\(P \in E\)</span>.</li>
</ul>
</div>
<p>If you’ve taken some abstract algebra, you’ll probably recognize that
the above is saying that <span class="math inline">\(E\)</span> is an
“abelian group” — but don’t worry about this if you don’t know what this
means.</p>
<div class="element">
<p><span class="label">Exercise</span> Explain geometrically why the
commutativity, identity, and inverses properties above hold.</p>
<p><em>Note</em>. It is also possible to explain geometrically why the
associativity property holds, but this is much much harder.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> What do you think goes wrong if
we start with a <em>singular</em> Weierstrass equation instead?</p>
</div>
<p>It is also useful to generalize the calculations we did above and
derive the following general formulas:</p>
<div class="element">
<p><span class="label">Elliptic Curve Addition Formula Theorem</span>
Suppose <span class="math inline">\(P = (x_1, y_1)\)</span> and <span
class="math inline">\(Q = (x_2, y_2)\)</span> are both points on the
curve <span class="math inline">\(y^2 = x^3 + ax + b\)</span>. Define
<span class="math display">\[ \lambda = \begin{cases}
\dfrac{y_2 - y_1}{x_2 - x_1} &amp; \text{if } P \neq Q \\
\dfrac{3x_1^2 + a}{2y_1} &amp; \text{if } P = Q
\end{cases} \]</span> If <span class="math inline">\(\lambda\)</span> is
defined (ie, if the denominator above is nonzero), set <span
class="math display">\[ \begin{aligned}
\nu &amp;= y_1 - \lambda x_1 \\
x_3 &amp;= \lambda^2 - x_1 - x_2 \\
y_3 &amp;= \lambda x_3 + \nu
\end{aligned} \]</span> Then <span class="math inline">\(P + Q = (x_3,
-y_3)\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Proof Exercise</span> Prove the Elliptic Curve
Addition Formula Theorem. <em>Hint</em>. The line passing through <span
class="math inline">\(P\)</span> and <span
class="math inline">\(Q\)</span> is <span class="math inline">\(y =
\lambda x + \nu\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Harder Proof Exercise</span> Use the Elliptic
Curve Addition Formula Theorem to prove algebraically that the
associativity property holds, ie, that <span class="math inline">\((P +
Q) + R = P + (Q + R)\)</span> for all <span class="math inline">\(P, Q,
R \in E\)</span>.</p>
</div>
<p>Let’s conclude our discussion of elliptic curves over the reals with
one more concrete example. This is another highly recommended
exercise!</p>
<div class="element">
<p><span class="label">Exercise</span> Consider the Weierstrass equation
<span class="math inline">\(y^2 = x^3 - 2x\)</span>.</p>
<ol type="a">
<li>Verify that this equation is nonsingular. Let <span
class="math inline">\(E\)</span> be the corresponding elliptic
curve.</li>
<li>Verify that <span class="math inline">\(P = (0, 0)\)</span> is on
the curve. What is <span class="math inline">\(2P\)</span>?</li>
<li>Verify that <span class="math inline">\(Q = (-1, 1)\)</span> is on
the curve. What is <span class="math inline">\(2Q\)</span>?</li>
<li>What is <span class="math inline">\(P + Q\)</span>?</li>
<li>What is <span class="math inline">\(3Q\)</span>?</li>
<li>What is <span class="math inline">\(4Q\)</span>?</li>
<li>What is <span class="math inline">\(5Q\)</span>?<br />
</li>
</ol>
</div>
<p>We can compute multiples of a point by using the same idea as binary
exponentiaton — except that maybe it’s better to call it “binary
multiplication” in this situation. Consider <span
class="math inline">\(P = (-2, 3)\)</span> on the elliptic curve defined
by <span class="math inline">\(y^2 = x^3 + 17\)</span> again. Let’s say
that we want to compute <span class="math inline">\(6P\)</span>, ie, the
sum of <span class="math inline">\(P\)</span> with itself 6 times. The
idea is to double repeatedly: <span class="math display">\[
\begin{aligned}
P &amp;= (-2, 3) \\
2P &amp;= (8, -23) \\
4P &amp;= 2(2P) = \left(\frac{752}{529}, -\frac{54239}{12167}\right)
\end{aligned} \]</span> We then put these together: <span
class="math display">\[ 6P = 4P + 2P = \left(\frac{752}{529},
-\frac{54239}{12167}\right) + (8, -23) = \left(
-\frac{4471631}{3027600}, -\frac{19554357097}{5268024000} \right).
\]</span></p>
<p>We also make the following definition of order.</p>
<div class="element">
<p><span class="label">Definition</span> Suppose <span
class="math inline">\(P\)</span> is a point on an elliptic curve <span
class="math inline">\(E\)</span>. The <em>order</em> of <span
class="math inline">\(P\)</span>, denoted <span
class="math inline">\(\mathrm{ord}_E(P)\)</span>, is the smallest
positive integer <span class="math inline">\(n\)</span> such that <span
class="math inline">\(nP = O\)</span>, if such an integer exists.
Otherwise, the order of <span class="math inline">\(P\)</span> is <span
class="math inline">\(\infty\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Let <span
class="math inline">\(E\)</span> be the elliptic curve defined by the
Weierstrass equation <span class="math inline">\(y^2 = x^3 -
4x\)</span>. Find the order of the following points.</p>
<ol type="a">
<li><span class="math inline">\(P = (-2, 0)\)</span>.<br />
</li>
<li><span class="math inline">\(Q = (0, 0)\)</span>.</li>
<li><span class="math inline">\(P + Q\)</span>.</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Let <span
class="math inline">\(E\)</span> be the elliptic curve defined by the
Weierstrass equation <span class="math inline">\(y^2 = x^3 + 5805x -
285714\)</span>. Verify that <span class="math inline">\(P = (327,
6048)\)</span> is a point on this curve, and then find its order by
hand.</p>
<p><em>Note</em>. This might be a little tedious, but it’s good
practice! It’s also not <em>that</em> horrendous: the answer is
somewhere between 5 and 10 ☺</p>
</div>
<div class="element">
<span class="label">SageCell</span> Here is some Sage code to create an
elliptic curve. Specifically, this code sets <code>E</code> to be the
elliptic curve corresponding to the equation <span
class="math inline">\(y^2 = x^3 + 17 = x^3 + 0 \cdot x + 17\)</span>. We
then define <code>P</code> the be the point <span
class="math inline">\((-2, 3)\)</span> on the curve <code>E</code> and
<code>Q</code> to be the point <span class="math inline">\((-1,
4)\)</span>, and then have Sage compute the sum for us!
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(QQ, [0, 17])
P = E(-2, 3)
Q = E(-1, 4)
P + Q
</script>
</div>
<p>A note about the format of the output: the point that we’ve been
calling <span class="math inline">\(O\)</span> is denoted by Sage as
<code>(0 : 1 : 0)</code>, and the point that we’d call <span
class="math inline">\((x, y)\)</span> is what Sage would denote by
<code>(x : y : 1)</code>. There are really good reasons for doing this
(these are what are called “projective coordinates” for the points), but
we don’t need to get into this. If you like, you can also specify points
on the curve in projective coordinates by writing things like
<code>P = E(-2, 3, 1)</code>.</p>
We can also get Sage to compute multiples for us:
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(QQ, [0, 17])
P = E(-2, 3)
6*P
</script>
</div>
<p>Note that the <code>QQ</code> in the above tells Sage to do exact
arithmetic with fractions, instead of using floating point decimal
approximations. If you don’t care about doing exact arithmetic, you can
replace the <code>QQ</code> with <code>RR</code> instead.</p>
</div>
<h2 id="elliptic-curves-mod-a-prime">4.10. Interlude: Elliptic Curves
Mod a Prime</h2>
<p>We now fix a prime <span class="math inline">\(p\)</span>. For
technical reasons that not worth lingering on for our cryptographic
purposes, we should assume <span class="math inline">\(p \neq 2,
3\)</span>, ie, that <span class="math inline">\(p \geq 5\)</span>. (In
applications to cryptography, <span class="math inline">\(p\)</span>
will anyway be very very large!)</p>
<p>We start with adapting our definitions above as follows.</p>
<div class="element">
<p><span class="label">Definition</span> A Weierstrass equation <span
class="math inline">\(y^2 = x^3 + ax + b\)</span> is <em>integral</em>
if <span class="math inline">\(a\)</span> and <span
class="math inline">\(b\)</span> are integers. We then say that the
equation is <em>singular mod <span class="math inline">\(p\)</span></em>
if <span class="math inline">\(\Delta \equiv 0 \pmod{p}\)</span>.
Otherwise, it is <em>nonsingular mod <span
class="math inline">\(p\)</span></em>.</p>
</div>
<p>Consider, for example, the Weierstrass equation <span
class="math inline">\(y^2 = x^3 + 17\)</span>. It is integral since
<span class="math inline">\(a = 0\)</span> and <span
class="math inline">\(b = 17\)</span> are integers. We calculated
earlier that <span class="math display">\[ \Delta = -16 \cdot 27 \cdot
17^2. \]</span> The only primes this is divisible by are 2, 3, and 17.
Thus the equation <span class="math inline">\(y^2 = x^3 + 17\)</span> is
singular mod <span class="math inline">\(p = 17\)</span>, but
nonsingular otherwise (recall that we are anyway ruling out <span
class="math inline">\(p = 2, 3\)</span>).</p>
<div class="element">
<p><span class="label">Exercise</span> For each of the following
integral Weierstrass equations, find all primes <span
class="math inline">\(p \geq 5\)</span> such that the equation is
singular mod <span class="math inline">\(p\)</span>.</p>
<ol type="a">
<li><span class="math inline">\(y^2 = x^3 - 2x\)</span></li>
<li><span class="math inline">\(y^2 = x^3 + x + 1\)</span></li>
<li><span class="math inline">\(y^2 = x^3 - 1\)</span></li>
</ol>
</div>
<p>When we have an integral Weierstrass equation <span
class="math inline">\(y^2 = x^3 + ax + b\)</span>, we can consider its
“solutions mod <span class="math inline">\(p\)</span>.” By this we mean
integers <span class="math inline">\((x, y)\)</span> such that <span
class="math inline">\(y^2 \equiv x^3 + ax + b \pmod{p}\)</span>. For
example, suppose <span class="math inline">\(p = 7\)</span> and consider
the Weierstrass equation <span class="math inline">\(y^2 = x^3 +
17\)</span>. Then <span class="math inline">\((1, 2)\)</span> is a
solution to the equation mod <span class="math inline">\(p\)</span>
because <span class="math display">\[ y^2 = 2^2 = 4 \equiv 18 = 1^3 + 17
= x^3 + 17 \pmod{7}. \]</span> Let’s define that, if <span
class="math inline">\(x, y, x&#39;, y&#39;\)</span> are all integers,
then <span class="math inline">\((x, y) \equiv (x&#39;, y&#39;)
\pmod{p}\)</span> means that <span class="math inline">\(x \equiv x&#39;
\pmod{p}\)</span> and <span class="math inline">\(y \equiv y&#39;
\pmod{p}\)</span>. Notice that, if <span class="math inline">\((x,
y)\)</span> is a solution mod <span class="math inline">\(p\)</span> of
<span class="math inline">\(y^2 = x^3 + ax + b\)</span>, then so is any
pair of integers that is congruent mod <span
class="math inline">\(p\)</span>. In the example above, observe that
<span class="math inline">\((1, 9)\)</span> or <span
class="math inline">\((8, 2)\)</span> or <span
class="math inline">\((-6, 9)\)</span> are all congruent mod 7 to <span
class="math inline">\((1,2)\)</span>, and they are all also solutions
mod 7 to <span class="math inline">\(y^2 = x^3 + 17\)</span>. We’ll
typically only consider solutions <span class="math inline">\((x,
y)\)</span> where <span class="math inline">\(0 \leq x, y &lt;
p\)</span>, in order to avoid having to list off all of the congruent
solutions.</p>
<p>It doesn’t really make sense to visualize (congruence classes of)
solutions to Weierstrass equations mod <span
class="math inline">\(p\)</span> in the same way that we visualized
solutions over the real numbers. Nonetheless, we can take the
<em>formulas</em> that we derived using the geometry we discussed above
(eg, the Elliptic Curve Addition Formula Theorem), and use the same
formulas to make sense of elliptic curves mod <span
class="math inline">\(p\)</span>. These formulas look very strange in
isolation, but it is important to remember where they come from: they
come from the same geometry involving secant and tangent lines that we
discussed above! If you understand that geometry, you can do all of the
same calculations “mod <span class="math inline">\(p\)</span>” and
derive the formulas that appear below.</p>
<div class="element">
<p><span class="label">Definition-Theorem</span> Suppose <span
class="math inline">\(y^2 = x^3 + ax + b\)</span> is an integral
Weierstrass equation which is nonsingular mod <span
class="math inline">\(p\)</span>. The corresponding <em>elliptic curve
mod <span class="math inline">\(p\)</span></em> is the set <span
class="math inline">\(E\)</span> of solutions mod <span
class="math inline">\(p\)</span> to the equation, together with an extra
<em>point at infinity</em> called <span
class="math inline">\(O\)</span>.</p>
<p>Suppose <span class="math inline">\(P \in E\)</span>. We define <span
class="math inline">\(-P\)</span> as follows:</p>
<ul>
<li>If <span class="math inline">\(P = O\)</span>, then <span
class="math inline">\(-P = O\)</span> also.</li>
<li>If <span class="math inline">\(P = (x, y)\)</span>, then <span
class="math inline">\(-P = (x, -y \bmod{p})\)</span>.</li>
</ul>
<p>Then <span class="math inline">\(-P\)</span> is in fact an element of
<span class="math inline">\(E\)</span>.</p>
<p>Moreover, suppose <span class="math inline">\(P, Q \in E\)</span>. We
define <span class="math inline">\(P + Q\)</span> as follows:</p>
<ul>
<li><p>If <span class="math inline">\(P = O\)</span>, then <span
class="math inline">\(P + Q = Q\)</span>.</p></li>
<li><p>If <span class="math inline">\(Q = O\)</span>, then <span
class="math inline">\(P + Q = P\)</span>.</p></li>
<li><p>Suppose <span class="math inline">\(P = (x_1, y_1)\)</span> and
<span class="math inline">\(Q = (x_2, y_2)\)</span> are both solutions
mod <span class="math inline">\(p\)</span> of <span
class="math inline">\(y^2 = x^3 + ax + b\)</span>.</p>
<ul>
<li>If <span class="math inline">\(P \neq Q\)</span> and <span
class="math inline">\(x_2 - x_1\)</span> is not invertible mod <span
class="math inline">\(p\)</span>, set <span class="math inline">\(P + Q
= O\)</span>.</li>
<li>If <span class="math inline">\(P = Q\)</span> and <span
class="math inline">\(y_1\)</span> is not invertible mod <span
class="math inline">\(p\)</span>, set <span class="math inline">\(P + Q
= 2P = O\)</span>.</li>
<li>Otherwise, define <span class="math display">\[ \lambda =
\begin{cases}
  (y_2 - y_1)(x_2 - x_1)^{-1} \bmod{p} &amp; \text{if } P \neq Q \\
  (3x_1^2 + a)(2y_1)^{-1} \bmod{p} &amp; \text{if } P = Q
  \end{cases} \]</span> Then set <span class="math display">\[
\begin{aligned}
  \nu &amp;= (y_1 - \lambda x_1) \bmod{p} \\
  x_3 &amp;= (\lambda^2 - x_1 - x_2) \bmod{p} \\
  y_3 &amp;= (\lambda x_3 + \nu) \bmod{p}
  \end{aligned} \]</span> Then <span class="math inline">\(R = (x_3,
y_3)\)</span> is a solution mod <span class="math inline">\(p\)</span>
and we define <span class="math inline">\(P + Q = -R = (x_3, -y_3
\bmod{p})\)</span>.</li>
</ul></li>
</ul>
<p>Then:</p>
<ul>
<li>(Associativity) <span class="math inline">\((P + Q) + R = P + (Q +
R)\)</span> for any <span class="math inline">\(P, Q, R \in
E\)</span>.</li>
<li>(Commutativity) <span class="math inline">\(P + Q = Q + P\)</span>
for any <span class="math inline">\(P, Q \in E\)</span>.</li>
<li>(Identity) <span class="math inline">\(P + O = P\)</span> for any
<span class="math inline">\(P \in E\)</span>.</li>
<li>(Inverses) <span class="math inline">\(P + (-P) = O\)</span> for any
<span class="math inline">\(P \in E\)</span>.</li>
</ul>
</div>
<p>Let’s do an example. Consider again <span class="math inline">\(p =
7\)</span> and the Weierstrass equation <span class="math inline">\(y^2
= x^3 + 17 \equiv x^3 + 3 \pmod{7}\)</span>. We’ve already seen that
<span class="math inline">\(P = (1, 2)\)</span> is a solution to this
equation. You should verify for yourself that <span
class="math inline">\(Q = (3, 4)\)</span> is <em>also</em> a solution to
this equation. Let’s think about computing <span class="math inline">\(P
+ Q\)</span> in “two” ways (but, as you’ll see, they’re both really the
same thing).</p>
<p>The first way is just to go through the above formulas carefully.
Notice that <span class="math inline">\(P \neq Q\)</span> and <span
class="math inline">\(x_2 - x_1 = 3 - 1 = 2\)</span> is invertible mod 7
because <span class="math inline">\(\gcd(2, 7) = 1\)</span>. Its inverse
is 4 (which we can compute by eyeballing since the numbers are small
enough in this case, but in general we would use the extended euclidean
algorithm). Thus <span class="math display">\[ \begin{aligned}
\lambda &amp;= (y_2 - y_1)(x_2 - x_1)^{-1} \bmod{p} \\
&amp;= (4 - 2)(3 - 1)^{-1} \bmod{7} \\
&amp;= 2 \cdot 4 \bmod{7} = 1.
\end{aligned} \]</span> Then <span class="math display">\[
\begin{aligned}
\nu &amp;= y_1 - \lambda x_1 \bmod{p} \\
&amp;= 2 - 1 \cdot 1 \bmod{7} = 1 \\
x_3 &amp;= \lambda^2 - x_1 - x_2 \bmod{p} \\
&amp;= 1^2 - 1 - 3 \bmod{7} = 4 \\
y_3 &amp;= \lambda x_3 + \nu \bmod{p} \\
&amp;= 1 \cdot 4 + 1 \bmod{7} = 5
\end{aligned} \]</span> Thus <span class="math inline">\(R = (4,
5)\)</span> and <span class="math inline">\(P + Q = -R = (4, -5
\bmod{7}) = (4, 2)\)</span>.</p>
<p>The second way (which, again, is really the same way!) is to remember
the geometry that underlies these formulas and use that geometry to
guide your calculations; you just have to remember to do your
calculations “mod 7” instead. We’re trying to add two distinct points,
so the first step is to find the line that passes through those points.
We compute the slope of that line as rise-over-run, ie, as <span
class="math inline">\((y_2 - y_1)/(x_2 - x_1)\)</span> — but we have to
do this calculation “mod 7,” so instead of dividing, we’ll multiply by a
modular inverse. In other words, we really compute <span
class="math display">\[ (4 - 2)(3 - 1)^{-1} = 2 \cdot 2^{-1} \equiv 2
\cdot 4 = 8 \equiv 1 \pmod{7}. \]</span> Notice that this is the same as
the value of <span class="math inline">\(\lambda\)</span> that we
computed above. The next step is to use point-slope form to find the
equation of the secant line: we now know it has slope 1, and it passes
through <span class="math inline">\((1, 2)\)</span>, so its equation
should be <span class="math inline">\(y - 2 = 1(x - 1)\)</span>, or
<span class="math inline">\(y = x + 1\)</span>. Notice that this <span
class="math inline">\(y\)</span>-intercept matches what we computed for
<span class="math inline">\(\nu\)</span> above. We next want to
intersect this secant line with the curve. We substitute <span
class="math inline">\(y = x + 1\)</span> into <span
class="math inline">\(y^2 = x^3 + 3\)</span> and get <span
class="math display">\[ \begin{aligned}
(x+1)^2 &amp;= x^3 + 3 \\
x^2 + 2x + 1 &amp;= x^3 + 3 \\
x^3 - x^2 - 2x + 2 &amp;= 0
\end{aligned} \]</span> We now need to find the roots of this cubic mod
7. We know that 1 and 3 are roots, so <span
class="math inline">\((x-1)(x-3) = x^2 - 4x + 3\)</span> must divide
this cubic.</p>
<div class="element">
<p><span class="label">Exercise</span> Do polynomial long division “mod
7” to divide <span class="math inline">\(x^3 - x^2 - 2x + 2\)</span> by
<span class="math inline">\(x^2 - 4x + 3\)</span>. You should find a
quotient of <span class="math inline">\(x-4\)</span> with remainder
0.</p>
</div>
<p>The fact that the quotient is <span
class="math inline">\(x-4\)</span> tells us that the third point of
intersection of the secant line with the curve has <span
class="math inline">\(x\)</span>-coordinate 4, so its <span
class="math inline">\(y\)</span>-coordinate must be <span
class="math inline">\(y = x + 1 = 4 + 1 = 5\)</span>. This gives us the
same point <span class="math inline">\(R = (4, 5)\)</span> that we found
earlier, and then we “reflect” across the <span
class="math inline">\(x\)</span>-axis to get <span
class="math display">\[ P + Q = (1, 2) + (3, 4) = (4, -5 \bmod{7}) = (4,
2), \]</span> just as we did before.</p>
<div class="element">
<p><span class="label">Exercise</span> Consider <span
class="math inline">\(p = 7\)</span> and <span class="math inline">\(y^2
= x^3 + 17\)</span> again. Compute the following:</p>
<ol type="a">
<li><span class="math inline">\((1, 2) + (1, 2)\)</span>.</li>
<li><span class="math inline">\((1, 2) + (1, 5)\)</span>.</li>
<li><span class="math inline">\((2, 2) + (3, 3)\)</span>.</li>
<li><span class="math inline">\((2, 2) + (2, 2)\)</span>.</li>
<li><span class="math inline">\((2, 2) + O\)</span>.</li>
<li><span class="math inline">\(O + O\)</span>.</li>
</ol>
</div>
<p>Again, we can quickly compute large multiples of a point using the
same “binary multiplication” idea.</p>
<div class="element">
<p><span class="label">Exercise</span> Consider <span
class="math inline">\(p = 7\)</span> and <span class="math inline">\(y^2
= x^3 + 17\)</span> again. Let <span class="math inline">\(P = (1,
2)\)</span> and use “binary multiplication” to compute <span
class="math inline">\(11P\)</span>.</p>
</div>
<p>We can also make the following definition of order.</p>
<div class="element">
<p><span class="label">Definition</span> Suppose <span
class="math inline">\(P\)</span> is a point on an elliptic curve <span
class="math inline">\(E\)</span> mod <span
class="math inline">\(p\)</span>. The <em>order</em> of <span
class="math inline">\(P\)</span>, denoted <span
class="math inline">\(\mathrm{ord}_E(P)\)</span>, is the smallest
positive integer <span class="math inline">\(n\)</span> such that <span
class="math inline">\(nP = O\)</span>.</p>
</div>
<p>Unlike in the real case, we don’t need to worry about infinite order
anymore:</p>
<div class="element">
<p><span class="label">Group Theory Exercise</span> Explain why, if
<span class="math inline">\(E\)</span> is an elliptic curve mod <span
class="math inline">\(p\)</span>, then it must be that <span
class="math inline">\(\mathrm{ord}_E(P)\)</span> is finite for any <span
class="math inline">\(E \in P\)</span>.</p>
</div>
<p>We also have the analogs of the First and Second Lemmas about Orders
in this case:</p>
<div class="element">
<p><span class="label">First Lemma About Orders for Elliptic
Curves</span> Let <span class="math inline">\(E\)</span> be an elliptic
curve mod <span class="math inline">\(p\)</span> and suppose <span
class="math inline">\(P \in E\)</span>. If <span
class="math inline">\(mP = O\)</span>, then <span
class="math inline">\(\mathrm{ord}_E(P)\)</span> divides <span
class="math inline">\(m\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Second Lemma About Orders for Elliptic
Curves</span> Let <span class="math inline">\(E\)</span> be an elliptic
curve mod <span class="math inline">\(p\)</span> and suppose <span
class="math inline">\(P \in E\)</span>. Let <span
class="math inline">\(k = \mathrm{ord}_E(P)\)</span>. Then <span
class="math inline">\(iP \equiv jP \pmod{p}\)</span> if and only if
<span class="math inline">\(i \equiv j \pmod{k}\)</span>. In particular,
the points <span class="math inline">\(O, P, 2P, 3P, \dotsc,
(k-1)P\)</span> are all incongruent mod <span
class="math inline">\(p\)</span>.</p>
</div>
<p>If you haven’t seen any group theory, you can just take these lemmas
for granted. But if you have studied some group theory, I highly
encourage you to work through the following exercise:</p>
<div class="element">
<p><span class="label">Group Theory Exercise</span> Prove the First and
Second Lemmas about Orders for elliptic curves.</p>
</div>
<p>Here are some concrete examples:</p>
<div class="element">
<p><span class="label">Exercise</span> Consider <span
class="math inline">\(p = 5\)</span> and <span class="math inline">\(y^2
= x^3 + 17\)</span>. Verify that the following points are on the
elliptic curve, and then calculate their orders.</p>
<ol type="a">
<li><span class="math inline">\((2, 0)\)</span></li>
<li><span class="math inline">\((3, 2)\)</span></li>
<li><span class="math inline">\((3, 3)\)</span></li>
<li><span class="math inline">\((4, 1)\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Consider <span
class="math inline">\(p = 7\)</span> and <span class="math inline">\(y^2
= x^3 + 17\)</span>. Show that <span class="math inline">\(P = (1,
2)\)</span> has order 13.</p>
</div>
<div class="element">
<span class="label">SageCell</span> Here is some Sage code to create an
elliptic curve mod <span class="math inline">\(p\)</span>. Specifically,
this code sets <code>E</code> to be the elliptic curve mod <span
class="math inline">\(p = 7\)</span> corresponding to the equation <span
class="math inline">\(y^2 = x^3 + 17 = x^3 + 0 \cdot x + 17\)</span>.
The <code>GF(7)</code> is what tells Sage that you want to work mod 7.
We then call <code>points()</code> to see a complete list of all the
(congruence classes of) points on the elliptic curve. Hit “Run,” and
then read below to understand more about the output:
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(GF(7), [0, 17])
E.points()
</script>
</div>
<p>Again, you will see points in projective coordinates when you do
this. For example, we saw above that <span class="math inline">\((1,
2)\)</span> is a solution to <span class="math inline">\(y^2 = x^3 +
17\)</span> mod 7, and Sage lists <code>(1 : 2 : 1)</code>, which refers
to the same point.</p>
If you already know a point <span class="math inline">\((x, y)\)</span>
on the elliptic curve, you can tell Sage to treat it as a point on the
elliptic curve by prefixing it with the name of the curve. The following
code defines <code>P</code> to be the point <span
class="math inline">\((1, 2)\)</span>.
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(GF(7), [0, 17])
P = E(1, 2)
P
</script>
</div>
You can now easily get Sage to perform addition on an elliptic curve for
you! The following computes <span class="math inline">\((1, 2) + (3,
4)\)</span>, the same calculation we did earlier. Hit “Run” to make sure
that Sage agrees that the answer is the point <span
class="math inline">\((4, 2)\)</span>.
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(GF(7), [0, 17])
E(1, 2) + E(3, 4)
</script>
</div>
We can also get Sage to calculate orders for us, as follows:
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(GF(7), [0, 17])
E(1, 2).order()
</script>
</div>
</div>
<div class="element">
<span class="label">SageCell</span> Earlier, I said that “it doesn’t
really make sense to visualize (congruence classes of) solutions to
Weierstrass equations mod <span class="math inline">\(p\)</span> in the
same way that we visualized solutions over the real numbers.” You
<em>could</em> make a plot of all of the points on the curve, but you
get very weird pictures: it doesn’t look anything like a “curve” and it
doesn’t make any sense to draw secant or tangent lines this. You can get
Sage to make these types of pictures for you as follows, but I don’t
recommend thinking too much about these pictures. They’re next to
meaningless…
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(GF(7), [0, 17])
E.plot()
</script>
</div>
</div>
<p>Having developed all of this theory, we can now state the basic
problem that underlies elliptic curve cryptography. You should compare
it with the discrete logarithm problem that we discussed above:</p>
<div class="element">
<p><span class="label">Elliptic Curve Discrete Logarithm Problem</span>
Suppose you are given a prime <span class="math inline">\(p\)</span>, an
elliptic curve <span class="math inline">\(E\)</span> mod <span
class="math inline">\(p\)</span>, and a point <span
class="math inline">\(P \in E\)</span>. Suppose further that <span
class="math inline">\(Q \in E\)</span> is known to be a multiple of
<span class="math inline">\(P\)</span>. Find the discrete logarithm base
<span class="math inline">\(P\)</span> of <span
class="math inline">\(Q\)</span>, ie, the unique integer <span
class="math inline">\(k\)</span> such that <span class="math inline">\(0
\leq k &lt; \mathrm{ord}_E(P)\)</span> such that <span
class="math inline">\(Q = mP\)</span>.</p>
</div>
<p>The naive method for doing this is to just try all the values of
<span class="math inline">\(k\)</span> starting from <span
class="math inline">\(k = 0\)</span> all the way up to <span
class="math inline">\(k = \mathrm{ord}_E(P) - 1\)</span>, but if <span
class="math inline">\(\mathrm{ord}_E(P)\)</span> is very large, this
will be very slow! There are <em>slightly</em> faster methods than this
that work <em>in general</em>. There are also <em>substantially</em>
faster methods that work <em>in special cases</em>. But we do not know
of anything that is <em>substantially</em> faster <em>in general</em>,
which means that by choosing <span class="math inline">\(p, E,
P\)</span> judiciously, we can make the Elliptic Curve Discrete
Logarithm Problem intractable for an adversary. This intractability can
then be used for cryptographic purposes, in much the same way that the
intractibility of the usual Discrete Logarithm Problem can be.</p>
<p>The National Institute of Standards and Technology (NIST)
<em>just</em> published (on February 3rd, 2023) a document describing
which elliptic curves are currently thought to be safe to use for
cryptography; you can browse this document <a
href="https://doi.org/10.6028/NIST.SP.800-186">here</a>.</p>
<div class="element">
<span class="label">SageCell</span> Sage can find discrete logarithms
for elliptic curves as well. Here is the syntax for finding the integer
<span class="math inline">\(m\)</span> such that <span
class="math inline">\((5, 3) = m(1, 2)\)</span>.
<div class="sage">
<script type="text/x-sage">
E = EllipticCurve(GF(7), [0, 17])
E(1, 2).discrete_log(E(5, 3))
</script>
</div>
</div>
<h2 id="elliptic-curve-diffie-hellman">4.11. Elliptic Curve
Diffie-Hellman</h2>
<p>Let’s start with the elliptic curve variant of the Diffie-Hellman key
exchange. Alice and Bob publicly agree to fix a prime <span
class="math inline">\(p\)</span>, an elliptic curve <span
class="math inline">\(E\)</span> mod <span
class="math inline">\(p\)</span> (specified by integers <span
class="math inline">\(a, b\)</span> such that the Weierstrass equation
<span class="math inline">\(y^2 = x^3 + ax + b\)</span> is nonsingular
mod <span class="math inline">\(p\)</span>), and a point <span
class="math inline">\(P \in E\)</span>. To ensure security, we need for
<span class="math inline">\(\mathrm{ord}_P(E)\)</span> to be large. The
data <span class="math inline">\((p, E, P)\)</span> is all shared
publicly.</p>
<p>Alice then chooses a secret integer <span class="math inline">\(0
\leq k_a &lt; \mathrm{ord}_E(P)\)</span> and sends Bob <span
class="math inline">\(Q_a = k_a P\)</span>. She can compute this value
quickly using binary multiplication. Bob similarly chooses a secret
integer <span class="math inline">\(0 \leq k_b &lt;
\mathrm{ord}_E(P)\)</span> and sends Alice <span
class="math inline">\(Q_b = k_b P\)</span>. Alice computes <span
class="math inline">\(R = k_a Q_b\)</span>, and Bob computes <span
class="math inline">\(R = k_b Q_a \bmod{p}\)</span>. The two values of
<span class="math inline">\(R\)</span> that Alice and Bob compute are
the same, because <span class="math display">\[ k_aQ_b \equiv k_a(k_bP)
= k_ak_bP = k_b(k_aP) = k_bQ_a. \]</span> Thus Alice and Bob now share a
secret point <span class="math inline">\(R\)</span> on the elliptic
curve.</p>
<div class="element">
<p><span class="label">Exercise</span> Suppose Alice and Bob publicly
agree to use the elliptic curve <span class="math inline">\(y^2 = x^3 +
17\)</span> mod <span class="math inline">\(p = 7\)</span> and the point
<span class="math inline">\(P = (1, 2)\)</span>.</p>
<ol type="a">
<li>Suppose Alice picks the number <span class="math inline">\(k_a =
4\)</span>. What is the message <span class="math inline">\(Q_a\)</span>
that she sends Bob?</li>
<li>Suppose Alice receivces the point <span class="math inline">\(Q_b =
(5, 3)\)</span> from Bob. What is her shared secret with Bob?</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Explain why the presumed
difficulty of finding elliptic curve discrete logarithms implies the
security of the elliptic curve Diffie-Hellman key exchange.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose Alice and Bob publicly
agree to use the elliptic curve <span class="math inline">\(y^2 = x^3 +
17\)</span> mod <span class="math inline">\(p = 7\)</span> and the point
<span class="math inline">\(P = (1, 2)\)</span>. This point has order
13, which is <em>too small</em> to be secure. Suppose Eve intercepts
Alice and Bob’s message: she sees that Alice sent Bob <span
class="math inline">\(Q_a = (3, 3)\)</span> and that Bob sent Alice
<span class="math inline">\(Q_b = (6, 4)\)</span>. What is Alice and
Bob’s shared secret?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Do one (or both!) of the
following:</p>
<ol type="a">
<li>Play the role of Alice and Bob: Pick a friend in the class and
perform an elliptic curve Diffie-Hellman key exchange with them. Do your
communications in our class stream on Zulip so that everyone can see the
values of <span class="math inline">\(p, E, P, Q_a, Q_b\)</span> that
you share between the two of you, but make sure to keep <span
class="math inline">\(a\)</span> and <span
class="math inline">\(b\)</span> secret.</li>
<li>Play the role of Eve: Watch for some pair of classmates performing
elliptic curve Diffie-Hellman on Zulip, and then see if you can figure
out their shared secret!</li>
</ol>
</div>
<div class="element">
<p><span class="label">Sage Exercise</span> Write some code that for
performing an elliptic curve Diffie-Hellman key exchange.</p>
</div>
<h2 id="quadratic-residues">4.12. Interlude: Quadratic Residues</h2>
<p>A familiar feature of the real numbers is that some numbers do not
have square roots (namely, the negatives). The same thing happens when
you work mod an integer. For example, let <span class="math inline">\(n
= 5\)</span>. We know that integer is congruent to 0, 1, 2, 3, or 4 mod
5. This means that any square must be congruent to <span
class="math inline">\(0^2 = 0, 1^2 = 1, 2^2 = 4, 3^2 \equiv 4
\pmod{5}\)</span>, or <span class="math inline">\(4^2 \equiv 1
\pmod{5}\)</span>. In other words, only 0, 1, or 4 have square roots mod
5 — and 2 and 3 do not!</p>
<div class="element">
<p><span class="label">Definition</span> Fix a positive integer <span
class="math inline">\(n\)</span>. We say that an integer <span
class="math inline">\(a\)</span> is a <em>quadratic residue mod <span
class="math inline">\(n\)</span></em> if it has a square root mod <span
class="math inline">\(n\)</span>, ie, if there exists an integer <span
class="math inline">\(x\)</span> such that <span
class="math inline">\(x^2 \equiv a \pmod{n}\)</span>.</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Find all quadratic residues mod
the following integers:</p>
<ol type="a">
<li><span class="math inline">\(n = 3\)</span></li>
<li><span class="math inline">\(n = 7\)</span></li>
<li><span class="math inline">\(n = 11\)</span></li>
</ol>
</div>
<p>We’ll see below that it will be useful to quickly determine whether
an integer <span class="math inline">\(a\)</span> is a quadratic residue
mod a prime <span class="math inline">\(p \geq 3\)</span>. It turns out
that there is a good way to do this! Let us first introduce the
following notation:</p>
<div class="element">
<p><span class="label">Definition</span> Let <span
class="math inline">\(p \geq 3\)</span> be prime. For any integer <span
class="math inline">\(a\)</span>, define the <em>Legendre symbol</em>
<span class="math inline">\((a/p)\)</span> by <span
class="math display">\[ \left( \frac{a}{p} \right) = \begin{cases} 0
&amp; \text{if } a \equiv 0 \pmod{p} \\
1 &amp; \text{if $a \not\equiv 0 \pmod{p}$ and $a$ is a quadratic
residue mod $p$} \\
-1 &amp; \text{if $a \not\equiv 0 \pmod{p}$ and $a$ is not a quadratic
residue mod $p$} \end{cases} \]</span></p>
</div>
<p>For example, we saw above that 4 is a quadratic residue mod 5, so
<span class="math display">\[ \left( \frac{4}{5} \right) = 1 \]</span>
and we saw that 2 is not a quadratic residue mod 5, so <span
class="math display">\[ \left( \frac{2}{5} \right) = -1. \]</span> We
can now rephrase our goal: we would like a quick way of computing
Legendre symbols. This is provided to us by combining binary
exponentiation with the following:</p>
<div class="element">
<p><span class="label">Euler’s Criterion</span> Let <span
class="math inline">\(p \geq 3\)</span> be prime. For any integer <span
class="math inline">\(a\)</span>, <span class="math display">\[ \left(
\frac{a}{p} \right) \equiv a^{(p-1)/2} \pmod{p}. \]</span></p>
</div>
<p><em>Proof</em>. There are three cases to consider:</p>
<ol type="1">
<li><span class="math inline">\(a \equiv 0 \pmod{p}\)</span>;</li>
<li><span class="math inline">\(a \not\equiv 0 \pmod{p}\)</span> and
<span class="math inline">\(a\)</span> is a quadratic residue mod <span
class="math inline">\(p\)</span>; and</li>
<li><span class="math inline">\(a \not\equiv 0 \pmod{p}\)</span> and
<span class="math inline">\(a\)</span> is <em>not</em> a quadratic
residue mod <span class="math inline">\(p\)</span>.</li>
</ol>
<p>In case (1), the statement we’re trying to prove is clear since both
sides of the congruence are 0 mod <span
class="math inline">\(p\)</span>. In case (2), there exists an integer
<span class="math inline">\(x\)</span> such that <span
class="math inline">\(x^2 \equiv a \pmod{p}\)</span>. Since <span
class="math inline">\(p\)</span> does not divide <span
class="math inline">\(a\)</span>, it also does not divide <span
class="math inline">\(x^2\)</span>, so it cannot divide <span
class="math inline">\(x\)</span> either by Euclid’s Lemma. Thus <span
class="math inline">\(\gcd(x, p) = 1\)</span>, and Euler’s Theorem
implies that <span class="math display">\[ a^{(p-1)/2} \equiv
(x^2)^{(p-1)/2} = x^{p-1} = x^{\phi(p)} \equiv 1 = \left( \frac{a}{p}
\right) \pmod{p}. \]</span></p>
<p>Now consider case (3). The idea is to calculate <span
class="math inline">\((p-1)!\)</span> mod <span
class="math inline">\(p\)</span> in two different ways, by “pairing off”
the numbers in two different ways. The first way is to pair them off
into pairs <span class="math inline">\(x, y\)</span> where <span
class="math inline">\(xy \equiv 1 \pmod{p}\)</span>. There are 2
“degenerate” pairs where <span class="math inline">\(x = y\)</span>,
namely, <span class="math inline">\(x = y = 1\)</span> and <span
class="math inline">\(x = y = p-1\)</span> (cf. Lemma 4.4.1), but the
remaining numbers <span class="math inline">\(2, \dotsc, p-2\)</span>
are all paired off with a different number in the same range and the
product of each of those “nondegenerate” pairs is 1, so the Modular
Arithmetic Theorem implies that <span class="math display">\[ (p-1)! = 1
\cdot 2 \cdot 3 \cdots (p-3) (p-2) (p-1) \equiv 1 \cdot (p-1) \equiv -1
\pmod{p}. \]</span> (This fact is sometimes called <em>Wilson’s
Theorem</em>.) On the other hand, we can also pair the numbers off into
pairs <span class="math inline">\(x, y\)</span> where <span
class="math inline">\(xy \equiv a \pmod{p}\)</span>. Since we are in
case (3) and <span class="math inline">\(a\)</span> is <em>not</em> a
quadratic residue mod <span class="math inline">\(p\)</span>, we know
that there is no solution to this congruence where <span
class="math inline">\(x = y\)</span>, ie, there are no “degenerate”
pairs in this case. There are <span
class="math inline">\((p-1)/2\)</span> pairs, and the product of each
pair is <span class="math inline">\(a\)</span>, so the Modular
Arithmetic Theorem again guarantees that <span class="math display">\[
(p-1)! = 1 \cdot 2 \cdots (p-2) \cdot (p-1) \equiv a^{(p-1)/2}
\equiv{p}. \]</span> Thus we have <span class="math display">\[
a^{(p-1)/2} \equiv (p-1)! \equiv -1 = \left( \frac{a}{p} \right)
\pmod{p} \]</span> and we are done. <span style="float: right;"><span
class="math inline">\(\Box\)</span></span></p>
<div class="element">
<p><span class="label">Proof Exercise</span> Here is a fact we tacitly
made use of <em>twice</em> in the above proof. Suppose <span
class="math inline">\(p\)</span> is prime and <span
class="math inline">\(a\)</span> is an integer that is not divisible by
<span class="math inline">\(p\)</span>. For any integer <span
class="math inline">\(1 \leq x \leq p-1\)</span>, there is a
<em>unique</em> integer <span class="math inline">\(1 \leq y \leq
p-1\)</span> such that <span class="math inline">\(xy \equiv a
\pmod{p}\)</span>.</p>
<ol type="a">
<li>Prove this fact.</li>
<li>Find the two places in the above proof where this fact was
used.</li>
</ol>
</div>
<p>Euler’s Criterion means that we have an efficient algorithm for
determining whether something is a quadratic residue: we simply use
binary exponentiation to compute <span class="math inline">\(a^{(p-1)/2}
\bmod{p}\)</span> and we can read off the answer! For example, suppose
we want to know if <span class="math inline">\(a = 37\)</span> is a
quadratic residue mod <span class="math inline">\(p = 97\)</span>. We
have <span class="math inline">\((p-1)/2 = 96/2 = 48\)</span>, so we
compute <span class="math inline">\(a^{(p-1)/2} = 37^{48}
\bmod{97}\)</span> using binary exponentiation, and we find that it is
<span class="math inline">\(96 \equiv -1 \pmod{97}\)</span>. Euler’s
Criterion says that <span class="math display">\[ \left( \frac{37}{97}
\right) \equiv 37^{(97-1)/2} = 37^{48} \equiv -1 \pmod{97}, \]</span>
which means that 37 is <em>not</em> a quadratic residue mod 97.</p>
<div class="element">
<p><span class="label">Exercise</span> Use Euler’s Criterion to
determine whether or not the following integers <span
class="math inline">\(a\)</span> are quadratic residues mod <span
class="math inline">\(p = 19\)</span>.</p>
<ol type="a">
<li><span class="math inline">\(a = 3\)</span></li>
<li><span class="math inline">\(a = 5\)</span></li>
<li><span class="math inline">\(a = 11\)</span></li>
</ol>
</div>
<div class="element">
<p><span class="label">Harder Proof Exercise</span> Suppose <span
class="math inline">\(p \geq 3\)</span> is prime.</p>
<ol type="a">
<li>Show that there are exactly <span
class="math inline">\((p+1)/2\)</span> quadratic residues mod <span
class="math inline">\(p\)</span>.</li>
<li>Conclude that, if <span class="math inline">\(p\)</span> is large,
then the probability that a randomly chosen integer in <span
class="math inline">\([0, p)\)</span> happens to be a quadratic residue
is approximately 50%.</li>
</ol>
</div>
<div class="element">
<span class="label">SageCell</span> Sage can compute Legendre symbols
using the <code>kronecker_symbol</code> function:
<div class="sage">
<script type="text/x-sage">
kronecker_symbol(33, 97)
</script>
</div>
When the Legendre symbol is not <span class="math inline">\(-1\)</span>,
Sage can also compute a modular square root:
<div class="sage">
<script type="text/x-sage">
Mod(33, 97).sqrt()
</script>
</div>
</div>
<div class="element">
<p><span class="label">Random Exercise</span> What does Sage output for
<code>Mod(k, n).sqrt()</code> when <span
class="math inline">\(k\)</span> is <em>not</em> a quadratic residue mod
<span class="math inline">\(n\)</span>? If you know what the words
“splitting field” and “finite field” mean, can you explain this behavior
in terms of these words?</p>
</div>
<p>There is a lot more that can be said about quadratic residues, though
this will be roughly enough for our purposes. If you are interested in
reading more, you should look up the <a
href="https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithm">Tonelli-Shanks
algorithm</a> for computing square roots mod <span
class="math inline">\(p\)</span>. You might also read more about <a
href="https://en.wikipedia.org/wiki/Jacobi_symbol#Calculating_the_Jacobi_symbol">Jacobi
symbols</a>, <a
href="https://en.wikipedia.org/wiki/Kronecker_symbol">Kronecker
symbols</a>, and <a
href="https://en.wikipedia.org/wiki/Quadratic_reciprocity">quadratic
reciprocity</a>.</p>
<h2 id="elliptic-curve-elgamal">4.13. Elliptic Curve Elgamal</h2>
<p>There is also a variant of the Elgamal cryptosystem using elliptic
curves that can be used to exchange messages, but there is a nontrivial
encoding step. To make Elgamal work with elliptic curves, we first need
a way to encode a plaintext message as a point on an elliptic curve
<span class="math inline">\(E\)</span> mod <span
class="math inline">\(p\)</span>.</p>
<p>There is a probabilistic algorithm for doing this. The rough idea is
that we can try to encode plaintext as the <span
class="math inline">\(x\)</span>-coordinate of a point, but note that
not every integer will occur as the <span
class="math inline">\(x\)</span>-coordinate of a point on an elliptic
curve mod <span class="math inline">\(p\)</span>! Specifically, if <span
class="math inline">\(E\)</span> is given by <span
class="math inline">\(y^2 = x^3 + ax + b\)</span> and if <span
class="math inline">\(P = (x, y)\)</span> is a point on the curve, then
the <span class="math inline">\(x\)</span>-coordinate must have the
property that <span class="math inline">\(x^3 + ax + b\)</span> is a
quadratic residue mod <span class="math inline">\(p\)</span>.</p>
<h3 id="entire-process">Entire Process</h3>
<p>Let us start by describing the Elgamal process in its entirety and in
the abstract.</p>
<p>Suppose that Bob would like to be able to receive messages of length
<span class="math inline">\(N\)</span>. Bob will fix a positive integer
<span class="math inline">\(s\)</span>. We will see that, the larger
that Bob chooses this integer, the higher the probability that encoding
will succeed. Bob will then choose a prime <span class="math inline">\(p
&gt; s26^N\)</span>, and an elliptic curve <span
class="math inline">\(E\)</span> mod <span
class="math inline">\(p\)</span> (defined by integers <span
class="math inline">\(a, b\)</span> such that the integral Weierstrass
equation <span class="math inline">\(y^2 = x^3 + ax + b\)</span> is
nonsingular mod <span class="math inline">\(p\)</span>), and a point
<span class="math inline">\(P \in E\)</span>. He computes <span
class="math inline">\(\mathrm{ord}_E(P)\)</span>. Then Bob chooses a
secret integer <span class="math inline">\(0 \leq k &lt;
\mathrm{ord}_E(P)\)</span> to serve as his private key. He computes
<span class="math inline">\(Q = kP\)</span>, and this value is part of
his public key. In other words, Bob will share all of the data <span
class="math inline">\((s, E, P, \mathrm{ord}_E(P), Q)\)</span> publicly,
and keep only the integer <span class="math inline">\(k\)</span>
secret.</p>
<p>Suppose now that Alice wants to send Bob a message. She first
converts her message into an integer <span
class="math inline">\(m\)</span> using the same base 26 idea we used for
RSA. She will then iterate through values of <span
class="math inline">\(r = 0, 1, 2, \cdots, s-1\)</span> until she finds
the first value of <span class="math inline">\(x = sm + r\)</span> such
that <span class="math display">\[ \left( \frac{x^3 + ax + b}{p} \right)
\neq -1. \]</span> Note that that the maximum possible value of <span
class="math inline">\(m\)</span> is <span class="math inline">\(26^N -
1\)</span>, so <span class="math display">\[ x = sm + r &lt; s(26^N-1) +
s = s26^N &lt; p, \]</span> since Bob chose <span
class="math inline">\(p\)</span> to be larger than <span
class="math inline">\(s26^N\)</span>. There is a roughly 1/2 chance that
an integer in <span class="math inline">\([0, p)\)</span> is not a
quadratic residue mod <span class="math inline">\(p\)</span>, and here
we are iterating through <span class="math inline">\(s\)</span> integers
in the range <span class="math inline">\([0, p)\)</span>, so there is a
<span class="math inline">\(1/2^s\)</span> chance that <span
class="math inline">\(x^3 + ax + b\)</span> is not a quadratic residue
for any of the <span class="math inline">\(s\)</span> possible values of
<span class="math inline">\(x = sm + r\)</span>. If none of the <span
class="math inline">\(s\)</span> integers are quadratic residues,
encoding fails — but if Bob chose <span class="math inline">\(s\)</span>
to be even moderately large, encoding failure is <em>very unlikely</em>!
If encoding does fail, Alice can just modify her message slightly
(rephrase slightly? add a nonsense letter?) and try encoding again. Once
Alice is able to find a value of <span class="math inline">\(x\)</span>
such that <span class="math inline">\(x^3 + ax + b\)</span> is a
quadratic residue mod <span class="math inline">\(p\)</span>, then there
is a integer <span class="math inline">\(y\)</span> such that <span
class="math inline">\(y^2 \equiv x^3 + ax + b \pmod{p}\)</span>, so the
point <span class="math inline">\(M = (x, y)\)</span> is on <span
class="math inline">\(E\)</span>. This will be the encoding of her
plaintext message.</p>
<p>This is not yet the ciphertext, but at this point she can encrypt the
encoded message using a process very similar to the Elgamal cryptosystem
we discussed earlier. Alice chooses an “ephemeral key” <span
class="math inline">\(h\)</span> such that <span class="math inline">\(0
\leq h &lt; \mathrm{ord}_E(P)\)</span>. She computes <span
class="math inline">\(S = hQ\)</span>, <span class="math inline">\(R_1 =
hP\)</span>, and <span class="math inline">\(R_2 = M + S\)</span>. The
pair <span class="math inline">\((R_1, R_2)\)</span> is the ciphertext
that she sends to Bob.</p>
<p>To decrypt the ciphertext <span class="math inline">\((R_1,
R_2)\)</span>, Bob uses his private key <span
class="math inline">\(k\)</span> to compute <span
class="math inline">\(S = kR_1\)</span>. Observe that <span
class="math display">\[ kR_1 = k(hP) = khP = h(kP) = hQ, \]</span> so
Bob has found the same value of <span class="math inline">\(S\)</span>
that Alice had, even though he does not know the value of the ephemeral
key <span class="math inline">\(h\)</span>. He can then compute <span
class="math inline">\(-S\)</span> by negating the <span
class="math inline">\(y\)</span>-coordinate, and he then calculates
<span class="math display">\[ R_2 - S = R_2 + (-S) = (M + S) + (-S) = M
+ (S + (-S)) = M + O = M. \]</span> He has thus recovered Alice’s
encoded plaintext!</p>
<p>Finally, Bob just needs to decode <span
class="math inline">\(M\)</span>. If <span class="math inline">\(M = (x,
y)\)</span>, he can extract the first coordinate <span
class="math inline">\(x\)</span>. The quotient when he divides this by
<span class="math inline">\(s\)</span> is the integer <span
class="math inline">\(m\)</span> that represents the message in base 26,
so he then finishes off by converting back to text using the same
process we used for RSA above.</p>
<p>Whew!</p>
<h3 id="encoding-and-decoding">Encoding and Decoding</h3>
<p>Here are some exercises to help you understand the above process by
breaking it down and working with some pieces. First up are the encoding
and decoding parts of the process (careful: not the encryption and
decryption yet).</p>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob’s public key has
<span class="math inline">\(s = 2, p = 97, a = 31\)</span>, and <span
class="math inline">\(b = 20\)</span>. The elliptic curve <span
class="math inline">\(E\)</span> is then the one given by <span
class="math inline">\(y^2 = x^3 + 31x + 20\)</span> mod <span
class="math inline">\(p = 97\)</span>.</p>
<ol type="a">
<li>What is the encoding of the plaintext message <code>B</code>? Follow
the process above to find the corresponding point <span
class="math inline">\(M \in E\)</span>.</li>
<li>Show that encoding fails for the letter <code>K</code>.</li>
<li>Follow the process described above to find the plaintext message
that results from decoding the point <span class="math inline">\((25,
30) \in E\)</span>.</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob’s public key has
<span class="math inline">\(p = 9393107\)</span> and <span
class="math inline">\(s = 3\)</span>.</p>
<ol type="a">
<li>What is the maximum length for messages that Bob can receive?</li>
<li>What is the probability of encoding failure?</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Bob would like to be able to
receive messages of length <span class="math inline">\(N = 50\)</span>
with an encoding failure rate of at most <span
class="math inline">\(0.1%\)</span>. What is the smallest prime <span
class="math inline">\(p\)</span> that he can use for his public key?</p>
<p><em>Hint</em>. You should probably use Sage to help you do this
calculation, and if you do, you might find it helpful to use the
function <code>next_prime</code>, which tells you the smallest prime
number greater than the input.</p>
</div>
<div id="sagecell-elliptic-curve-encoding" class="element">
<span class="label">SageCell</span> Here is a SageCell that implements
the encoding step described above. Note that it will output the point
<span class="math inline">\(M \in E\)</span> with three coordinates
where the third coordinate will always be 1 (for technical reasons);
this is the same as what you observed in the previous elliptic curve
SageCells, except that here commas are used to separate the three
numbers instead of colons.
<div class="sage">
<script type="text/x-sage">
from re import sub

# Remove all non alphabetic characters and capitalize
def encode(text: str):
    stripped = sub(r"[^a-zA-Z]", "", text)
    return stripped.upper()

# Encode a string as a list of numbers 0--25
def numerify(text: str):
    return [(ord(x) - 65) for x in encode(text)]
    
# Get integer representation
def integerify(text: str):
    n = 0
    for i, x in enumerate(reversed(numerify(text))):
        n += x * 26^i
    return n

# Encode text as a point on an elliptic curve
def elliptic_encode(text: str, E, s):
    m = integerify(text)
    p = E.base_ring().cardinality()
    a = E.ainvs()[3]
    b = E.ainvs()[4]
    for r in range(s):
        x = Mod(s*m + r, p)
        f = x^3 + a*x + b
        if kronecker_symbol(f, p) != -1:
            return E(x, Mod(f, p).sqrt())
    raise Exception("Encoding fails")
    
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(text=input_box(default="HIBOB", label="Input", height=2, width=70),
      s=input_box(default="10", label="s", width=62),
      p=input_box(default="31624898780568028223033578567554929233454460200496038308094584218593743", label="p", width=62),
      a=input_box(default="2231", label="a", width=62),
      b=input_box(default="924384923849", label="b", width=62)):
    
    text = encode(text)
    o = f"Probability of encoding failure: {float(0.5^s)}"
    o += "<br/>"
    o += f"Maximum message length: {floor(log(p/s, 26))}"
    o += "<br/>"
    o += f"Input message length: {len(text)}"
    output_div("Remarks", o)
    
    E = EllipticCurve(GF(p), [a, b])  
    o = elliptic_encode(text, E, s)
    output_div("Output", f'<textarea readonly rows="2" cols="70">{ tuple(o) }</textarea>')
</script>
</div>
Here is another SageCell that implements the decoding step.
<div class="sage">
<script type="text/x-sage">
# Turn a list of numbers 0--25 back into a string
def denumerify(nums: list):
    return "".join([chr((x % 26) + 65) for x in nums])

# Get text from integer representation
def deintegerify(n: int):
    n = int(n)
    rems = []
    while n > 0:
        rems.append(n % 26)
        n = n // 26
    return denumerify(reversed(rems))

# Decode a point on an elliptic curve into plaintext
def elliptic_decode(M, E, s):
    return deintegerify(M[0] // s)
    
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(M=input_box(default="(33404810, 14631728016432515480233802166029066516512428400786216396603964460676414, 1)", label="Input", width=62),
      s=input_box(default="10", label="s", width=62),
      p=input_box(default="31624898780568028223033578567554929233454460200496038308094584218593743", label="p", width=62),
      a=input_box(default="2231", label="a", width=62),
      b=input_box(default="924384923849", label="b", width=62)):
    
    E = EllipticCurve(GF(p), [a, b])  
    M = E(M)
    o = elliptic_decode(M, E, s)
    output_div("Output", f'<textarea readonly rows="2" cols="70">{ o }</textarea>')
</script>
</div>
</div>
<div class="element">
<p><span class="label">Exercise</span> Describe in your own words what
goes wrong if Alice tries to encode a message that is too long (based on
what Bob chose for his values of <span class="math inline">\(p\)</span>
and <span class="math inline">\(s\)</span>). You might find it helpful
to experiment with the above SageCells.</p>
</div>
<h3 id="encryption-and-decryption">Encryption and Decryption</h3>
<p>Here is an example of the encryption and decryption process in a
small example and using Sage. I encourage you to follow along and type
things into a SageCell yourself as you read through this example (or you
can do the calculations by hand, though this might get a little tiring
even in this small example).</p>
<p>When generating his elliptic curve Elgamal public key, Bob chooses
the elliptic curve <span class="math inline">\(E\)</span> defined by
<span class="math inline">\(y^2 = x^3 + 3x + 4\)</span> mod <span
class="math inline">\(p = 7\)</span> and the point <span
class="math inline">\(P = (5, 5) \in E\)</span>.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>E <span class="op">=</span> EllipticCurve(GF(<span class="dv">7</span>), [<span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> E(<span class="dv">5</span>, <span class="dv">5</span>)</span></code></pre></div>
<p>By running <code>P.order()</code>, we find that <span
class="math inline">\(\mathrm{ord}_E(P) = 10\)</span>. Suppose Bob
chooses the secret integer <span class="math inline">\(k = 3\)</span>.
By typing <code>3*P</code> into Sage, he finds that <span
class="math inline">\(Q = kP = 3 \cdot (5, 5) = (2, 5)\)</span>. All
parts of this calculation <em>except</em> the value of <span
class="math inline">\(k = 3\)</span> are made public; <span
class="math inline">\(k\)</span> is his private decryption key.</p>
<p>Now suppose Alice wants to send Bob a message. She sets up her Sage
session by pulling the following information from Bob’s public key.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>E <span class="op">=</span> EllipticCurve(GF(<span class="dv">7</span>), [<span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> E(<span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> E(<span class="dv">2</span>, <span class="dv">5</span>)</span></code></pre></div>
<p>Suppose that, following the encryption process described above, her
encoded message is the point <span class="math inline">\(M = (0,
5)\)</span>. She chooses an ephemeral key between <span
class="math inline">\(0\)</span> and <span
class="math inline">\(\mathrm{ord}_E(P) = 10\)</span>, say <span
class="math inline">\(h = 4\)</span>. She must keep this value of <span
class="math inline">\(h\)</span> secret. She computes <span
class="math inline">\(R_1 = hP\)</span> by typing <span
class="math inline">\(4 * P\)</span> into Sage and finds <span
class="math inline">\(R_1 = (0, 2)\)</span>. She then computes <span
class="math inline">\(R_2 = M + S = M + hQ\)</span> by typing
<code>E(0, 5) + 4*Q</code> into Sage and finds <span
class="math inline">\(R_2 = (1, 6)\)</span>. The pair <span
class="math inline">\((R_1, R_2) = ((0, 2), (1, 6))\)</span> is the
ciphertext that she sends to Bob.</p>
<p>Let’s now go backwards and check that Bob is able to recover Alice’s
message. He computes <span class="math inline">\(M = R_2 - kR_1\)</span>
by typing <code>E(1, 6) - 3*E(0, 2)</code> and finds <span
class="math inline">\(M = (0, 5)\)</span>, which was Alice’s encoded
message!</p>
<div class="element">
<p><span class="label">Exercise</span> When generating his elliptic
curve Elgamal public key, Bob chooses the elliptic curve <span
class="math inline">\(E\)</span> defined by <span
class="math inline">\(y^2 = x^3 - 3x + 3\)</span> mod <span
class="math inline">\(p = 11\)</span> and the point <span
class="math inline">\(P = (10, 7) \in E\)</span>.</p>
<ol type="a">
<li>What is <span class="math inline">\(\mathrm{ord}_E(P)\)</span>?</li>
<li>Suppose Bob chooses <span class="math inline">\(k = 4\)</span>. What
is the value of <span class="math inline">\(Q = kP\)</span>?</li>
<li>Alice encodes some message to produce the point <span
class="math inline">\(M = (1, 1) \in E\)</span>. She also generates the
ephemeral key <span class="math inline">\(h = 2\)</span>. What is the
ciphertext <span class="math inline">\((R_1, R_2)\)</span> that she
sends to Bob?</li>
<li>Check that if Bob decrypts the ciphertext <span
class="math inline">\((R_1, R_2)\)</span> that he receives from Alice,
he does in fact recover <span class="math inline">\(M = (1,
1)\)</span>.</li>
<li>Bob receives the message <span class="math inline">\(((6, 5), (10,
4))\)</span> from Alice. What is the encoded plaintext point <span
class="math inline">\(M \in E\)</span>?</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob’s elliptic curve
Elgamal public key is as follows: <span class="math display">\[
\begin{aligned}
s &amp;= 10 \\
p &amp;= 965840826414842165347088832781 \\
E &amp;: y^2 = x^3 + 2x + 1 \\
P &amp;= (537016992844572701251197286080,
809430503509725487398100177667) \\
\mathrm{ord}_E(P) &amp;= 965840826414840286830465288570 \\
Q &amp;= (636209278006637725237624425202,
310653932799215077905485882454)
\end{aligned} \]</span></p>
<ol type="a">
<li>What is the probability that encoding fails?</li>
<li>Alice wants to send Bob the message
<code>I have turned into a cat</code>. What is the ciphertext she sends
Bob?</li>
</ol>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob’s elliptic curve
Elgamal public key is as follows: <span class="math display">\[
\begin{aligned}
s &amp;= 10 \\
p &amp;= 884300930387974803998998733399 \\
E &amp;: y^2 = x^3 + 2x + 1 \\
P &amp;= (361652577940189312498172547614,
514746227051815551959384860286) \\
\mathrm{ord}_E(P) &amp;= 884300930387974691696035383315 \\
Q &amp;= (882188314538809138823874338820,
772608417660306453415686049932)
\end{aligned} \]</span> His private key is <span class="math display">\[
k = 587487808581088164390024475576. \]</span> He receives the following
ciphertext <span class="math inline">\((R_1, R_2)\)</span> from Alice.
<span class="math display">\[ \begin{aligned}
R_1 &amp;= (779503153810704949581662586128,
391600280839951295424353453750) \\
R_2 &amp;= (590367533102870068877884575138,
460366500620283882415563572675)
\end{aligned} \]</span> What is the plaintext (as text, rather than as
an encoded point)?</p>
</div>
<div class="element">
<p><span class="label">Exercise</span> Suppose Bob’s elliptic curve
Elgamal public key is as follows: <span class="math display">\[
\begin{aligned}
s &amp;= 10 \\
p &amp;= 34159136004208027161199 \\
E &amp;: y^2 = x^3 + 2x + 1 \\
P &amp;= (5205000772914715415725, 20236812690413582503099 \\
\mathrm{ord}_E(P) &amp;= 34159136004127088328131 \\
Q &amp;= (25509677592482725856096, 823756708348136845691)
\end{aligned} \]</span> Unfortunately, his public key is not large
enough to be secure! What is his private decryption key <span
class="math inline">\(k\)</span>?</p>
</div>
<div id="sagecell-elliptic-curve-elgamal" class="element">
<p><span class="label">SageCell</span> Here is a SageCell that
implements Elgamal encryption. When you hit “Run,” you’ll see the
following input boxes:</p>
<ul>
<li><code>Input</code> for the input plaintext</li>
<li><code>s</code> for the integer <span
class="math inline">\(s\)</span> that controls the encoding failure
rate</li>
<li><code>p</code> for the prime mod which we’ll consider our elliptic
curve <span class="math inline">\(E\)</span></li>
<li><code>a</code> and <code>b</code> for the coefficients of the
Weierstrass equation <span class="math inline">\(y^2 = x^3 + ax +
b\)</span> of <span class="math inline">\(E\)</span></li>
<li><code>P</code> for the coordinates of a point on the curve</li>
<li><code>order</code> for <span
class="math inline">\(\mathrm{ord}_E(P)\)</span></li>
<li><code>Q</code> for the coordinates of some multiple of
<code>P</code></li>
</ul>
<p>The SageCell will then compute the corresponding ciphertext pair
<span class="math inline">\((R_1, R_2)\)</span> that Alice sends to Bob
and display it in the <code>Output</code> box. Again, each point <span
class="math inline">\(R_1, R_2\)</span> will be represented by three
coordinates; the point <span class="math inline">\(O\)</span> will be
represented by <code>(0, 1, 0)</code>, and a point <span
class="math inline">\((x, y)\)</span> will be represented by
<code>(x, y, 1)</code>. Again, this is the same format for points that
you are familiar with from the earlier elliptic curve SageCells, except
that we use commas instead of colons to separate the numbers.</p>
<p>Note that the encryption generates a random ephemeral key, so you’ll
see different ciphertexts every time you run this SageCell even if all
of the input fields are exactly the same!</p>
<div class="sage">
<script type="text/x-sage">
from re import sub

# Remove all non alphabetic characters and capitalize
def encode(text: str):
    stripped = sub(r"[^a-zA-Z]", "", text)
    return stripped.upper()

# Encode a string as a list of numbers 0--25
def numerify(text: str):
    return [(ord(x) - 65) for x in encode(text)]
    
# Get integer representation
def integerify(text: str):
    n = 0
    for i, x in enumerate(reversed(numerify(text))):
        n += x * 26^i
    return n

# Encode text as a point on an elliptic curve
def elliptic_encode(text: str, s, E):
    m = integerify(text)
    p = E.base_ring().cardinality()
    a = E.ainvs()[3]
    b = E.ainvs()[4]
    for r in range(s):
        x = Mod(s*m + r, p)
        f = x^3 + a*x + b
        if kronecker_symbol(f, p) != -1:
            return E(x, Mod(f, p).sqrt())
    raise Exception("Encoding fails")

# Encrypt the encoded message M
def encrypt(M, E, P, order, Q):
    ephemeral = randint(0, order-1)
    return (ephemeral*P, M + ephemeral*Q)
    
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(text=input_box(default="HIBOB", label="Input", height=2, width=70),
      s=input_box(default="10", label="s", width=62),
      p=input_box(default="31624898780568028223033578567554929233454460200496038308094584218593743", label="p", width=62),
      a=input_box(default="2231", label="a", width=62),
      b=input_box(default="924384923849", label="b", width=62),
      P=input_box(default="(28242533037372562028376915025599704895624883370665290980560308139223847, 27339484572109674275112696180600875534462601488783406730716833705598007, 1)", label="P", width=62),
      order=input_box(default="31624898780568028223033578567554928906213834570791083268618301693807894", label="order", width=62),
      Q=input_box(default="(14860594925009170003954530097202645513024232456550100199567054270027585, 31448458171617918642007942988642343116727272631897730366311554311900365, 1)", label="Q", width=62)):
    
    text = encode(text)
    o = f"Probability of encoding failure: {float(0.5^s)}"
    o += "<br/>"
    o += f"Maximum message length: {floor(log(p/s, 26))}"
    o += "<br/>"
    o += f"Input message length: {len(text)}"
    output_div("Remarks", o)
    
    E = EllipticCurve(GF(p), [a, b])  
    P = E(P)
    Q = E(Q)
      
    M = elliptic_encode(text, s, E)
    R = encrypt(M, E, P, order, Q)
    o = (tuple(R[0]), tuple(R[1]))
    
    output_div("Output", f'<textarea readonly rows="2" cols="70">{ o }</textarea>')
</script>
</div>
<p>The next SageCell implements decryption. You’ll see a lot of the same
fields as above, except now:</p>
<ul>
<li><code>Input</code> should be ciphertext; in other words, it is a
pair of points on the elliptic curve <span
class="math inline">\(E\)</span>, in the same format as the output of
the above encryption SageCell</li>
<li><code>k</code> is the decryption key, which must be specified</li>
</ul>
<p>The <code>Output</code> is the corresponding plaintext.</p>
<div class="sage">
<script type="text/x-sage">
# Turn a list of numbers 0--25 back into a string
def denumerify(nums: list):
    return "".join([chr((x % 26) + 65) for x in nums])

# Get text from integer representation
def deintegerify(n: int):
    n = int(n)
    rems = []
    while n > 0:
        rems.append(n % 26)
        n = n // 26
    return denumerify(reversed(rems))

# Decode a point on an elliptic curve into plaintext
def elliptic_decode(M, E, s):
    return deintegerify(M[0] // s)

# Decrypt the ciphertext pair R
def decrypt(R, E, k):
    return R[1] - k*R[0]
    
# Prints an output div aligning with the interact controls   
def output_div(label: str, content: str):
    s = '<div class="sagecell_interactControlCell" style="width: 100%;">'
    s += f'<label class="sagecell_interactControlLabel">{label}</label>'
    s += f'<div class="sagecell_interactControl">{content}</div>'
    s += '</div>'
    pretty_print(html(s))

@interact
def _(cipher=input_box(default="((12439165645636780372408872819196985400098429041444905471841965054215852, 13168353947844887098155880466151122665060908575026632194378808065612145, 1), (10653009826871052250391884872759053215859987410006331499967649660641664, 4230942832501466957956641218702916607547526549773148196384944547108179, 1))", label="Input", width=62),
      s=input_box(default="10", label="s", width=62),
      p=input_box(default="31624898780568028223033578567554929233454460200496038308094584218593743", label="p", width=62),
      a=input_box(default="2231", label="a", width=62),
      b=input_box(default="924384923849", label="b", width=62),
      P=input_box(default="(28242533037372562028376915025599704895624883370665290980560308139223847, 27339484572109674275112696180600875534462601488783406730716833705598007, 1)", label="P", width=62),
      order=input_box(default="31624898780568028223033578567554928906213834570791083268618301693807894", label="order", width=62),
      Q=input_box(default="(14860594925009170003954530097202645513024232456550100199567054270027585, 31448458171617918642007942988642343116727272631897730366311554311900365, 1)", label="Q", width=62),
      k=input_box(default="3378570623517000468044706849659752427201103476704244805424841619588371", label="K", width=62)):
    
    E = EllipticCurve(GF(p), [a, b])  
    P = E(P)
    Q = E(Q)
    R = (E(cipher[0]), E(cipher[1]))
    
    M = decrypt(R, E, k)
    o = elliptic_decode(M, E, s)
    
    output_div("Output", f'<textarea readonly rows="2" cols="70">{ o }</textarea>')
</script>
</div>
</div>
<div class="element">
<p><span class="label">Exercise</span> Do one (or more!) of the
following:</p>
<ol type="a">
<li>Play the role of Bob: Choose an elliptic curve Elgamal public key
for yourself and post it to our class stream on Zulip.</li>
<li>Play the role of Alice: Watch for a classmate who has posted their
elliptic curve Elgamal public key to Zulip, and send them a secret
message.</li>
<li>Play the role of Eve: Watch for an elliptic curve Elgamal ciphertext
being exchanged by some pair of your classmates on Zulip, and see if you
can figure out what the plaintext is.</li>
</ol>
</div>
<aside id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>I do not know if it is known how to prove that finding
<span class="math inline">\(d\)</span> is computationally equivalent to
finding <span class="math inline">\(\phi(n)\)</span>, or if this is an
open problem. I would be grateful if someone could tell me!<a
href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>

</main>


</body>

</html>
